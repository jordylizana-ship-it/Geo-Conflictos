<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" href="/icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoConflictos Chile - Mapa de Conflictos Socioambientales</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3366cc;
            --primary-dark: #2a52a2;
            --primary-light: #eaf3ff;
            --accent: #e63946;
            --light-gray: #f8f9fa;
            --card-bg: #ffffff;
            --text-dark: #202122;
            --text-light: #54595d;
            --border-color: #dee2e6;
            --green: #00af89;
            --orange: #f58d00;
            --space-lg: 1.5rem;
            --space-md: 1.25rem;
            --space-sm: 0.75rem;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        html, body { background-color: var(--light-gray); color: var(--text-dark); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; width: 100%; overflow-x: hidden; }
        #app { display: flex; flex-direction: column; min-height: 100vh; }
        
        .main-container { display: flex; flex-direction: column; flex-grow: 1; padding: var(--space-lg); gap: var(--space-lg); width: 100%; max-width: 1400px; margin: 0 auto; }

        .header {
            background: #ffffff;
            padding: var(--space-sm) var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }
        .header .logo-container {
            height: 50px; /* Altura del logo */
            flex-shrink: 0;
        }
        .header .logo-container img {
            height: 100%;
            width: auto; /* Ancho automático para mantener proporción */
            object-fit: contain; /* Asegura que la imagen completa se vea */
        }
        .header .title-group { display: flex; flex-direction: column; }
        .header .logo-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-dark);
            line-height: 1.2;
        }
        .header .logo-subtitle {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .explanation-section { 
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            padding: var(--space-lg);
            text-align: center;
            animation: fadeInSlideDown 0.8s ease-out forwards; 
            opacity:0; 
            transform: translateY(-20px);
        }
        .explanation-section h1 {
            font-family: 'EB Garamond', serif;
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .explanation-section h1 .icon {
            color: var(--primary);
        }
        .explanation-section p { 
            font-size: 1rem; 
            color: var(--text-light); 
            line-height: 1.7;
            max-width: 700px; 
            margin: 0 auto; 
        }
        .explanation-section p strong {
            font-weight: 600;
            color: var(--primary-dark);
        }
        
        @keyframes fadeInSlideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        
        .map-and-panels-wrapper { display: flex; flex-grow: 1; gap: var(--space-lg); min-height: 600px; }
        .filters-panel { width: 280px; background-color: var(--card-bg); border-radius: 0.75rem; padding: var(--space-md); overflow-y: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); flex-shrink: 0; border: 1px solid var(--border-color); }
        .filters-panel h2 { font-size: 1.1rem; margin-bottom: var(--space-md); color: var(--primary); display: flex; align-items: center; gap: 0.5rem; }
        
        .filter-group { margin-bottom: var(--space-md); }
        .filter-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-dark); font-size: 0.9rem; }
        .input-wrapper { position: relative; }
        .input-wrapper .icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            pointer-events: none;
            transition: color 0.2s;
        }
        .input-wrapper input, .input-wrapper select {
            appearance: none; -webkit-appearance: none; -moz-appearance: none;
            background-color: var(--light-gray);
            border: 2px solid var(--light-gray);
            border-radius: 0.5rem;
            padding: 0.8rem;
            padding-left: 2.8rem;
            width: 100%;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-wrapper select {
            background-image: url('data:image/svg+xml;utf8,<svg fill="%2354595d" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 1.2rem;
        }
        .input-wrapper input:focus, .input-wrapper select:focus {
            outline: none;
            border-color: var(--primary);
            background-color: #fff;
        }
        .input-wrapper input:focus + .icon, .input-wrapper select:focus + .icon {
            color: var(--primary);
        }

        .map-area { flex-grow: 1; position: relative; z-index: 1; background-color: var(--card-bg); border-radius: 0.75rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid var(--border-color); overflow: hidden; }
        #map { width: 100%; height: 100%; }
        .right-panel-wrapper { position: relative; width: 360px; flex-shrink: 0; z-index: 100; }
        .details-panel { width: 100%; height: 100%; background-color: var(--card-bg); box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: absolute; right: 0; top: 0; transform: translateX(105%); opacity: 0; pointer-events: none; transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out; display: none; flex-direction: column; border-radius: 0.75rem; border: 1px solid var(--border-color); }
        .details-panel.active { transform: translateX(0); opacity: 1; pointer-events: auto; display: flex; }
        .details-header { padding: var(--space-md); background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; position: relative; flex-shrink: 0; border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem; }
        #conflict-name-text { font-size: 1.3rem; font-weight: 700; margin-right: 2rem; }
        #conflict-sector { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 99px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .close-btn { position: absolute; top: 0.8rem; right: 0.8rem; background: none; border: none; font-size: 1.8rem; color: rgba(255,255,255,0.8); cursor: pointer; line-height: 1; transition: color 0.2s; }
        .close-btn:hover { color: white; }
        .details-body { padding: var(--space-md); overflow-y: auto; flex-grow: 1; }
        .action-buttons { display: flex; flex-direction: column; gap: 0.75rem; margin-top: var(--space-md); border-top: 1px solid var(--border-color); padding-top: var(--space-md); }
        .action-btn { display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.8rem; border-radius: 0.5rem; border: none; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; }
        .btn-wikidata { background-color: var(--primary); color: white; }
        .btn-wikipedia { background-color: var(--green); color: white; }
        .action-btn:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .stats-panel-wrapper { width: 100%; height: 100%; background-color: var(--card-bg); border-radius: 0.75rem; padding: var(--space-md); overflow-y: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); flex-shrink: 0; border: 1px solid var(--border-color); }
        .stats-panel h2 { font-size: 1.1rem; margin-bottom: var(--space-md); color: var(--primary); display: flex; align-items: center; gap: 0.5rem; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-lg); }
        .stat-card { display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-sm); background-color: var(--card-bg); border-radius: 0.5rem; border-left: 4px solid; }
        .stat-icon { font-size: 1.2rem; flex-shrink: 0; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; }
        .stat-info { display: flex; flex-direction: column; align-items: flex-start; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--text-dark); }
        .stat-label { font-size: 0.8rem; color: var(--text-light); }
        .stat-total { border-color: var(--primary); }
        .stat-total .stat-icon { background-color: var(--primary); }
        .stat-active { border-color: var(--accent); }
        .stat-active .stat-icon { background-color: var(--accent); }
        .stat-latent { border-color: var(--orange); }
        .stat-latent .stat-icon { background-color: var(--orange); }
        .stat-resolved { border-color: var(--green); }
        .stat-resolved .stat-icon { background-color: var(--green); }

        .sector-chart { margin-top: var(--space-md); }
        .sector-item { display: flex; align-items: center; margin-bottom: 1.2rem; }
        .sector-icon-wrapper { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: var(--space-sm); flex-shrink: 0; }
        .sector-icon { color: white; font-size: 1rem; }
        .sector-content { flex: 1; display: flex; flex-direction: column; }
        .sector-label { font-size: 0.9rem; font-weight: 600; color: var(--text-dark); margin-bottom: 0.3rem; }
        .sector-bar-wrapper { display: flex; align-items: center; width: 100%; }
        .sector-bar-container { flex-grow: 1; background-color: #e0e0e0; border-radius: 5px; height: 8px; overflow: hidden; margin-right: 0.5rem; }
        .sector-bar { height: 100%; border-radius: 5px; transition: width 0.8s ease-out; }
        .percentage-value { font-weight: 600; color: var(--text-dark); font-size: 0.85rem; min-width: 35px; text-align: right; }
        
        .details-status-banner { padding: var(--space-sm) var(--space-md); margin-bottom: var(--space-lg); border-radius: 0.5rem; display: flex; align-items: center; gap: var(--space-sm); font-weight: 600; font-size: 1rem; border-left-width: 5px; border-left-style: solid; }
        .details-status-banner .icon { font-size: 1.2rem; }
        .status-Activo { background-color: hsl(4, 79%, 96%); color: hsl(4, 79%, 40%); border-color: hsl(4, 79%, 60%); }
        .status-Latente { background-color: hsl(35, 100%, 96%); color: hsl(35, 100%, 35%); border-color: hsl(35, 100%, 50%); }
        .status-Resuelto { background-color: hsl(162, 100%, 96%); color: hsl(162, 100%, 25%); border-color: hsl(162, 100%, 35%); }
        .status-Desconocido { background-color: hsl(210, 8%, 96%); color: hsl(210, 8%, 40%); border-color: hsl(210, 8%, 60%); }
        .details-description { font-size: 0.95rem; line-height: 1.7; color: var(--text-dark); margin-bottom: var(--space-lg); border-bottom: 1px solid var(--border-color); padding-bottom: var(--space-lg); }
        .details-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); }
        .info-item { display: flex; align-items: flex-start; gap: var(--space-sm); }
        .info-item .icon { font-size: 1.1rem; color: var(--primary); margin-top: 0.15rem; }
        .info-item .content label { font-size: 0.8rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.2rem; display: block; }
        .info-item .content .value { font-size: 0.95rem; font-weight: 500; color: var(--text-dark); }
        
        footer { background-color: white; border-top: 1px solid var(--border-color); padding: var(--space-md) 0; flex-shrink: 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .footer-container { max-width: 1400px; margin: 0 auto; padding: 0 var(--space-lg); text-align: center; color: var(--text-light); }
        .footer-logos { display: flex; justify-content: center; align-items: center; gap: var(--space-lg); margin-bottom: var(--space-sm); }
        .footer-logos img { height: 40px; width: auto; }
        .footer-text { font-size: 0.9rem; margin-bottom: 0.5rem; }
        .footer-copyright { font-size: 0.8rem; }
        .loading { display: flex; justify-content: center; align-items: center; height: 100%; font-size: 1.2rem; color: var(--text-light); position: absolute; width: 100%; background-color: rgba(255,255,255,0.7); z-index: 10; border-radius: 0.75rem; }
        .loading::after { content: ""; width: 24px; height: 24px; border: 3px solid var(--border-color); border-top: 3px solid var(--primary); border-radius: 50%; margin-left: 12px; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .message { padding: var(--space-sm) var(--space-md); text-align: center; background-color: var(--primary-light); border-radius: 0.75rem; color: var(--primary); border-left: 4px solid var(--primary); position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1001; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        @media (max-width: 1200px) { .map-and-panels-wrapper { flex-direction: column; height: auto; min-height: unset; } .filters-panel, .right-panel-wrapper, .map-area { width: 100%; height: auto; } .map-area { height: 60vh; min-height: 450px; } .details-panel { position: relative; transform: none; opacity: 1; pointer-events: auto; } }
        @media (max-width: 768px) { .main-container { padding: var(--space-sm); } .header { flex-direction: column; gap: 0.5rem; text-align: center; } }
    </style>
</head>
<body>
    <div id="app">
        <header class="header">
            <div class="logo-container">
                <img src="/logo.png" alt="Logo Wikimedia Chile">
            </div>
            <div class="title-group">
                <h1 class="logo-title">GeoConflictos Chile</h1>
                <p class="logo-subtitle">Mapa de conflictos socioambientales</p>
            </div>
        </header>

        <div class="main-container">
            <div class="explanation-section">
                <h1><i class="fas fa-map-signs icon"></i> Bienvenido a GeoConflictos</h1>
                <p>Esta plataforma interactiva utiliza <strong>datos abiertos</strong> para mapear y explorar las <strong>tensiones territoriales y ambientales</strong> a lo largo de Chile.</p>
            </div>
            <div class="map-and-panels-wrapper">
                <div class="filters-panel">
                    <h2><i class="fas fa-filter"></i> Filtros</h2>
                    <div class="filter-group">
                        <label for="search">Buscar por nombre</label>
                        <div class="input-wrapper">
                            <input type="text" id="search" placeholder="Ej: Pascua Lama...">
                            <i class="fas fa-search icon"></i>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label for="region-filter">Región</label>
                        <div class="input-wrapper">
                            <select id="region-filter"><option value="">Cargando regiones...</option></select>
                            <i class="fas fa-map-marked-alt icon"></i>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label for="type-filter">Sector</label>
                        <div class="input-wrapper">
                           <select id="type-filter"><option value="">Cargando sectores...</option></select>
                           <i class="fas fa-industry icon"></i>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label for="status-filter">Estado</label>
                        <div class="input-wrapper">
                            <select id="status-filter">
                                <option value="">Todos los estados</option>
                                <option value="Activo">Activo</option>
                                <option value="Latente">Latente</option>
                                <option value="Resuelto">Resuelto</option>
                                <option value="Desconocido">Desconocido</option>
                            </select>
                            <i class="fas fa-lightbulb icon"></i>
                        </div>
                    </div>
                     <div class="filter-group">
                        <label for="date-filter">Fecha de inicio</label>
                        <div class="input-wrapper">
                           <input type="date" id="date-filter">
                           <i class="fas fa-calendar-alt icon"></i>
                        </div>
                    </div>
                </div>
                
                <div class="map-area">
                    <div id="map"></div>
                </div>
                
                <div class="right-panel-wrapper">
                    <div class="stats-panel-wrapper" id="stats-panel-wrapper">
                        <div class="stats-panel" id="stats-panel-content">
                            </div>
                    </div>
                    <div class="details-panel" id="details-panel"></div>
                </div>
            </div>
        </div>
        
        <footer>
            <div class="footer-container">
                <div class="footer-logos">
                    <a href="https://www.wikimedia.cl/" target="_blank" rel="noopener noreferrer"><img src="/wikiemdia foundation logo.webp" alt="Logo Wikimedia Chile"></a>
                    <a href="https://www.wikidata.org/" target="_blank" rel="noopener noreferrer"><img src="/wikidata logo.png" alt="Logo Wikidata"></a>
                </div>
                <p class="footer-text">Desarrollado con datos de Wikidata, un proyecto de la Fundación Wikimedia.</p>
                <p class="footer-copyright">© <span id="current-year"></span> Wikimedia Chile. Contenido disponible bajo licencia CC BY-SA 4.0.</p>
            </div>
        </footer>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DEFINICIONES Y CONSTANTES ---
            const sectorKeywords = { 'Minero': ["minero", "minera", "mina", "pascua lama", "casale", "collahuasi", "codelco", "cobre", "litio"], 'Agua': ["agua", "hídrico", "represa", "río", "lago", "hidroeléctrica", "hidroaysén", "escasez", "glaciar", "sequía", "embalse", "mar", "océano", "costa", "puerto"], 'Forestal': ["forestal", "celulosa", "arauco", "cmpc", "bosque", "árbol", "plantación"], 'Industrial': ["industrial", "contaminación", "quintero", "refinería", "plomo", "pesquero", "salmonera", "derrame", "empresa"], 'Energético': ["energético", "termoeléctrica", "central", "carbón", "eólico", "eléctrica", "solar", "gas", "petróleo"], 'Protesta Social': ["protesta", "social", "estallido", "huelga", "disputa", "movilización", "comunidad", "vecinos", "mapuche"] };
            const sectorColors = { 'Minero': "#ff9800", 'Agua': "#2196f3", 'Forestal': "#4caf50", 'Industrial': "#f44336", 'Energético': "#9c27b0", 'Protesta Social': "#e91e63", 'Otro': "#607d8b" };
            const sectorIcons = { 'Minero': "fas fa-mountain", 'Agua': "fas fa-water", 'Forestal': "fas fa-tree", 'Industrial': "fas fa-industry", 'Energético': "fas fa-bolt", 'Protesta Social': "fas fa-users", 'Otro': "fas fa-question-circle" };
            const statusInfo = { 'Activo': { icon: 'fa-fire-alt', text: 'Conflicto Activo' }, 'Latente': { icon: 'fa-hourglass-half', text: 'Conflicto Latente' }, 'Resuelto': { icon: 'fa-check-circle', text: 'Conflicto Resuelto' }, 'Desconocido': { icon: 'fa-question-circle', text: 'Estado Desconocido' } };
            
            // --- INICIALIZACIÓN Y VARIABLES GLOBALES ---
            document.getElementById("current-year").textContent = new Date().getFullYear();
            const map = L.map("map").setView([-35.6751, -71.543], 5);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }).addTo(map);
            const markers = L.featureGroup().addTo(map);
            let allConflicts = [];
            
            const detailsPanel = document.getElementById("details-panel");
            const statsPanelWrapper = document.getElementById("stats-panel-wrapper");
            const statsPanelContent = document.getElementById("stats-panel-content");

            // --- LÓGICA PRINCIPAL (OBTENCIÓN DE DATOS) ---
            async function fetchWikidata() {
                showLoading(true);
                const sparqlQuery = `SELECT ?conflict ?conflictLabel ?description ?coords ?startDate ?endDate ?regionLabel ?wikipediaUrl WHERE { { ?conflict wdt:P17 wd:Q298. } UNION { ?conflict wdt:P131+ ?loc . ?loc wdt:P17 wd:Q298. } VALUES ?type { wd:Q5683226 wd:Q472983 wd:Q1983228 wd:Q1193633 wd:Q49343 wd:Q274880 } ?conflict wdt:P31 ?type. OPTIONAL { ?conflict wdt:P625 ?coords. } OPTIONAL { ?conflict wdt:P580 ?startDate. } OPTIONAL { ?conflict wdt:P582 ?endDate. } OPTIONAL { ?conflict wdt:P131* ?regionInstance . ?regionInstance wdt:P31/wdt:P279* wd:Q10864048. SERVICE wikibase:label { bd:serviceParam wikibase:language "es,en". ?regionInstance rdfs:label ?regionLabel. } } OPTIONAL { ?wikipediaUrl schema:about ?conflict; schema:inLanguage "es"; schema:isPartOf <https://es.wikipedia.org/>. } SERVICE wikibase:label { bd:serviceParam wikibase:language "es,en". ?conflict rdfs:label ?conflictLabel; schema:description ?description. } }`;
                const url = `https://query.wikidata.org/sparql?query=${encodeURIComponent(sparqlQuery)}&format=json`;
                
                try {
                    const response = await fetch(url, { headers: { 'Accept': 'application/json' } });
                    if (!response.ok) throw new Error(`Error de red: ${response.status}`);
                    const data = await response.json();
                    processData(data);
                } catch (error) {
                    console.error("Error fetching conflicts:", error);
                    showError("No se pudieron cargar los conflictos desde Wikidata.");
                } finally {
                    showLoading(false);
                }
            }
            
            function processData(data) {
                const uniqueConflicts = new Map();
                data.results.bindings.forEach(b => {
                    const id = b.conflict.value.split('/').pop();
                    if (!uniqueConflicts.has(id)) {
                        const conflict = { id: id, name: b.conflictLabel?.value || 'Sin nombre', description: b.description?.value || 'Sin descripción', startDate: b.startDate?.value, endDate: b.endDate?.value, region: b.regionLabel?.value || 'No especificada', coords: null, wikipediaUrl: b.wikipediaUrl?.value };
                        if (b.coords) { const match = b.coords.value.match(/Point\(([-\d.]+) ([-\d.]+)\)/); if (match) conflict.coords = [parseFloat(match[2]), parseFloat(match[1])]; }
                        conflict.status = determineStatus(conflict.startDate, conflict.endDate);
                        conflict.sector = getConflictSector(conflict);
                        uniqueConflicts.set(id, conflict);
                    }
                });
                allConflicts = Array.from(uniqueConflicts.values());
                displayData(allConflicts);
                updateStats(allConflicts);
                populateFilters(allConflicts);
            }
            
            // --- FUNCIONES DE UI Y AUXILIARES ---
            function closeDetailsPanel() {
                detailsPanel.classList.remove('active');
                statsPanelWrapper.style.display = 'block';
            }

            async function showConflictDetails(conflict) {
                statsPanelWrapper.style.display = 'none';
                const status = statusInfo[conflict.status] || statusInfo['Desconocido'];

                detailsPanel.innerHTML = `
                    <div class="details-header">
                        <button class="close-btn" id="close-details-dynamic">&times;</button>
                        <h2 id="conflict-name-text">${conflict.name}</h2>
                        <div id="conflict-sector-wrapper">
                            <span id="conflict-sector" style="background-color: ${sectorColors[conflict.sector] || '#607d8b'}; color: white;">${conflict.sector}</span>
                        </div>
                    </div>
                    <div class="details-body">
                        <div class="details-status-banner status-${conflict.status}">
                            <i class="fas ${status.icon} icon"></i>
                            <span>${status.text}</span>
                        </div>
                        <div class="details-description" id="conflict-description-dynamic">${conflict.description}</div>
                        <div class="details-info-grid">
                            <div class="info-item">
                                <i class="fas fa-map-marked-alt icon"></i>
                                <div class="content">
                                    <label>Región</label>
                                    <span class="value">${conflict.region}</span>
                                </div>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-calendar-alt icon"></i>
                                <div class="content">
                                    <label>Fecha de inicio</label>
                                    <span class="value">${conflict.startDate ? new Date(conflict.startDate).toLocaleDateString() : 'Desconocido'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="action-btn btn-wikidata" id="btn-wikidata-dynamic"><i class="fas fa-database"></i> Ver en Wikidata</button>
                            <button class="action-btn btn-wikipedia" id="btn-wikipedia-dynamic"><i class="fab fa-wikipedia-w"></i> Ver en Wikipedia</button>
                        </div>
                    </div>
                `;
                detailsPanel.classList.add('active');
                document.getElementById('close-details-dynamic').addEventListener('click', closeDetailsPanel);
                document.getElementById('btn-wikidata-dynamic').onclick = () => window.open(`https://www.wikidata.org/wiki/${conflict.id}`, '_blank');
                const btnWikipedia = document.getElementById('btn-wikipedia-dynamic');
                if (conflict.wikipediaUrl) { btnWikipedia.onclick = () => window.open(conflict.wikipediaUrl, '_blank'); } 
                else { btnWikipedia.disabled = true; btnWikipedia.style.opacity = 0.5; }
                const descriptionElement = document.getElementById('conflict-description-dynamic');
                const originalDescription = conflict.description;
                const genericDescriptions = ['conflicto socioambiental', 'conflicto ambiental', 'conflicto social', 'mina', 'protesta', 'disputa', 'huelga', 'sin descripción'];
                if (genericDescriptions.includes(originalDescription.toLowerCase().trim()) && conflict.wikipediaUrl) {
                    descriptionElement.innerHTML = '<i>Cargando descripción desde Wikipedia...</i>';
                    try {
                        const summary = await fetchWikipediaSummary(conflict.wikipediaUrl);
                        if (summary) { descriptionElement.textContent = summary; conflict.description = summary; } 
                        else { descriptionElement.textContent = originalDescription; }
                    } catch (error) { console.error(error); descriptionElement.textContent = originalDescription; }
                }
            }

            async function fetchWikipediaSummary(wikipediaUrl) {
                if (!wikipediaUrl) return null;
                const pageTitle = decodeURIComponent(wikipediaUrl.split('/').pop());
                const apiUrl = `https://es.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(pageTitle)}`;
                const response = await fetch(apiUrl);
                if (!response.ok) return null;
                const data = await response.json();
                return data.extract || null;
            }

            function updateStats(conflicts) {
                statsPanelContent.innerHTML = `
                    <h2><i class="fas fa-chart-bar"></i> Estadísticas</h2>
                    <div class="stats-grid">
                        <div class="stat-card stat-total">
                            <div class="stat-icon"><i class="fas fa-globe-americas"></i></div>
                            <div class="stat-info"><div class="stat-value" id="total-conflicts">0</div><div class="stat-label">Total</div></div>
                        </div>
                        <div class="stat-card stat-active">
                            <div class="stat-icon"><i class="fas fa-fire-alt"></i></div>
                            <div class="stat-info"><div class="stat-value" id="active-conflicts">0</div><div class="stat-label">Activos</div></div>
                        </div>
                        <div class="stat-card stat-latent">
                            <div class="stat-icon"><i class="fas fa-hourglass-half"></i></div>
                            <div class="stat-info"><div class="stat-value" id="latent-conflicts">0</div><div class="stat-label">Latentes</div></div>
                        </div>
                        <div class="stat-card stat-resolved">
                            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                            <div class="stat-info"><div class="stat-value" id="resolved-conflicts">0</div><div class="stat-label">Resueltos</div></div>
                        </div>
                    </div>
                    <h3><i class="fas fa-industry"></i> Distribución por Sector</h3>
                    <div class="sector-chart" id="sector-chart-container"></div>
                `;
                document.getElementById("total-conflicts").textContent = conflicts.length;
                document.getElementById("active-conflicts").textContent = conflicts.filter(c => c.status === 'Activo').length;
                document.getElementById("latent-conflicts").textContent = conflicts.filter(c => c.status === 'Latente').length;
                document.getElementById("resolved-conflicts").textContent = conflicts.filter(c => c.status === 'Resuelto').length;
                const sectors = {};
                conflicts.forEach(c => { sectors[c.sector] = (sectors[c.sector] || 0) + 1; });
                const sectorChartContainer = document.getElementById("sector-chart-container");
                sectorChartContainer.innerHTML = "";
                Object.entries(sectors).sort(([, a], [, b]) => b - a).forEach(([sector, count]) => {
                    const percentage = conflicts.length > 0 ? ((count / conflicts.length) * 100).toFixed(0) : 0;
                    const item = document.createElement("div");
                    item.className = "sector-item";
                    item.innerHTML = `<div class="sector-icon-wrapper" style="background-color: ${sectorColors[sector] || '#607d8b'}"><i class="${sectorIcons[sector] || 'fas fa-question-circle'} sector-icon"></i></div><div class="sector-content"><div class="sector-label">${sector}</div><div class="sector-bar-wrapper"><div class="sector-bar-container"><div class="sector-bar" style="width: ${percentage}%; background-color: ${sectorColors[sector] || '#607d8b'};"></div></div><span class="percentage-value">${percentage}%</span></div></div>`;
                    sectorChartContainer.appendChild(item);
                });
            }

            function displayData(conflicts) {
                markers.clearLayers();
                const conflictsWithCoords = conflicts.filter(c => c.coords);
                conflictsWithCoords.forEach(conflict => {
                    const markerColor = sectorColors[conflict.sector] || '#607d8b';
                    const icon = L.divIcon({ className: 'custom-marker', html: `<div style="background-color: ${markerColor}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 8px rgba(0,0,0,0.6);"></div>`, iconSize:[24,24], iconAnchor:[12,12] });
                    const marker = L.marker(conflict.coords, { icon: icon }).addTo(markers);
                    marker.bindPopup(`<strong>${conflict.name}</strong><br><em>${conflict.sector}</em>`);
                    marker.on("click", () => showConflictDetails(conflict));
                });
                if (markers.getLayers().length > 0) { map.invalidateSize(); map.fitBounds(markers.getBounds(), { padding: [50, 50] }); }
            }

            function populateFilters(conflicts) {
                const regionFilter = document.getElementById('region-filter');
                const typeFilter = document.getElementById('type-filter');
                const regionSet = new Set(conflicts.map(c => c.region).filter(r => r && r !== 'No especificada'));
                const sectorSet = new Set(conflicts.map(c => c.sector).filter(Boolean));
                regionFilter.innerHTML = '<option value="">Todas las regiones</option>';
                Array.from(regionSet).sort().forEach(r => { regionFilter.innerHTML += `<option value="${r}">${r}</option>`; });
                typeFilter.innerHTML = '<option value="">Todos los sectores</option>';
                Array.from(sectorSet).sort().forEach(s => { typeFilter.innerHTML += `<option value="${s}">${s}</option>`; });
            }
            
            function filterData() {
                const regionVal = document.getElementById('region-filter').value;
                const typeVal = document.getElementById('type-filter').value;
                const statusVal = document.getElementById('status-filter').value;
                const searchVal = document.getElementById('search').value.toLowerCase();
                const dateVal = document.getElementById('date-filter').value;
                
                const filtered = allConflicts.filter(c => 
                    (!regionVal || c.region === regionVal) && 
                    (!typeVal || c.sector === typeVal) && 
                    (!statusVal || c.status === statusVal) && 
                    (!dateVal || (c.startDate && new Date(c.startDate) >= new Date(dateVal))) &&
                    (!searchVal || c.name.toLowerCase().includes(searchVal) || c.description.toLowerCase().includes(searchVal))
                );
                
                displayData(filtered);
                updateStats(filtered);
            }

            function showLoading(isLoading) {
                let loadingEl = document.getElementById('loading-indicator');
                if (isLoading && !loadingEl) {
                    loadingEl = document.createElement('div');
                    loadingEl.id = 'loading-indicator';
                    loadingEl.className = 'loading';
                    loadingEl.textContent = 'Consultando Wikidata... ';
                    document.querySelector('.map-area').appendChild(loadingEl);
                } else if (!isLoading && loadingEl) { loadingEl.remove(); }
            }

            function showError(message) {
                let errorDiv = document.querySelector('.message');
                if (!errorDiv) { errorDiv = document.createElement('div'); errorDiv.className = 'message'; document.querySelector('.map-area').appendChild(errorDiv); }
                errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
                setTimeout(() => { if(errorDiv) errorDiv.remove() }, 5000);
            }

            function determineStatus(startDateStr, endDateStr) {
                const now = new Date();
                if (endDateStr && new Date(endDateStr) < now) return 'Resuelto';
                if (startDateStr) return new Date(startDateStr) < new Date(now.getFullYear() - 15, now.getMonth(), now.getDate()) ? 'Latente' : 'Activo';
                return 'Desconocido';
            }

            function getConflictSector(conflict) {
                const textToSearch = `${conflict.name.toLowerCase()} ${conflict.description.toLowerCase()}`;
                for (const [sector, keywords] of Object.entries(sectorKeywords)) { if (keywords.some(k => textToSearch.includes(k))) return sector; }
                return 'Otro';
            }

            // --- EVENT LISTENERS ---
            ['search', 'region-filter', 'type-filter', 'status-filter', 'date-filter'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', filterData);
            });

            // --- CARGA INICIAL ---
            fetchWikidata();
        });
    </script>
</body>
</html>