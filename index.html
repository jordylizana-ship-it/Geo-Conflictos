<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <link rel="icon" href="/icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoConflictos - Mapa Multiling√ºe de Conflictos Socioambientales</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3366cc;
            --primary-dark: #2a52a2;
            --primary-light: #eaf3ff;
            --accent: #e63946;
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --text-primary: #202122;
            --text-secondary: #54595d;
            --border-color: #dee2e6;
            --green: #00af89;
            --orange: #f58d00;
            --commons-blue: #00599c;
            --space-lg: 1.5rem;
            --space-md: 1.25rem;
            --space-sm: 0.75rem;
            --input-bg: #f1f5f9;
        }

        :root[data-theme="dark"] {
            --primary: #4299e1;
            --primary-dark: #2b6cb0;
            --primary-light: #2c5282;
            --accent: #f56565;
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --border-color: #4a5568;
            --green: #48bb78;
            --orange: #ed8936;
            --commons-blue: #3a82c4;
            --input-bg: #4a5568;
        }
        
        [v-cloak] { display: none; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        html, body { background-color: var(--bg-primary); color: var(--text-primary); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; width: 100%; overflow-x: hidden; transition: background-color 0.3s, color 0.3s; }
        html.tutorial-active, body.tutorial-active { overflow: hidden; }
        #app { display: flex; flex-direction: column; min-height: 100vh; }
        
        .main-container { display: flex; flex-direction: column; flex-grow: 1; padding: var(--space-lg); gap: var(--space-lg); width: 100%; max-width: 1400px; margin: 0 auto; }

        .header {
            background: var(--bg-secondary);
            padding: var(--space-sm) var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-md);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .header-left { display: flex; align-items: center; gap: var(--space-md); }
        .header .logo-container { height: 50px; flex-shrink: 0; }
        .header .logo-container img { height: 100%; width: auto; object-fit: contain; }
        .header .title-group { display: flex; flex-direction: column; }
        .header .logo-title { font-size: 1.4rem; font-weight: 700; color: var(--text-primary); line-height: 1.2; }
        .header .logo-subtitle { font-size: 0.9rem; color: var(--text-secondary); }
        .header-right { display: flex; align-items: center; gap: 1rem; }
        
        .lang-switcher { position: relative; }
        .lang-switcher-btn { background: var(--primary-light); color: var(--primary-dark); border: none; padding: 0.6rem 1rem; border-radius: 50px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; transition: background-color 0.2s; }
        html[data-theme="dark"] .lang-switcher-btn { color: var(--primary); background: var(--bg-primary); }
        .lang-switcher-btn:hover { background-color: #d8e6ff; }
        html[data-theme="dark"] .lang-switcher-btn:hover { background-color: #4a5568; }
        .lang-dropdown { position: absolute; top: 110%; right: 0; background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); list-style: none; padding: 0.5rem; z-index: 1005; min-width: 150px; }
        .lang-dropdown li { padding: 0.7rem 1rem; cursor: pointer; border-radius: 0.25rem; font-weight: 500; }
        .lang-dropdown li:hover { background-color: var(--bg-primary); }

        .theme-switcher-btn {
            background-color: var(--bg-primary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.2s ease;
        }
        .theme-switcher-btn:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        .map-and-panels-wrapper { display: flex; flex-grow: 1; gap: var(--space-lg); min-height: 600px; margin-top: 1rem; }
        .filters-panel { width: 280px; background-color: var(--bg-secondary); border-radius: 0.75rem; padding: var(--space-md); overflow-y: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); flex-shrink: 0; border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s; }
        .filters-panel h2 { font-size: 1.1rem; margin-bottom: var(--space-md); color: var(--primary); display: flex; align-items: center; gap: 0.5rem; }
        
        .filter-group { margin-bottom: var(--space-md); }
        .filter-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary); font-size: 0.9rem; }
        .input-wrapper { position: relative; }
        .input-wrapper .icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none; transition: color 0.2s; }
        .input-wrapper input, .input-wrapper select { appearance: none; -webkit-appearance: none; -moz-appearance: none; background-color: var(--input-bg); border: 2px solid transparent; border-radius: 0.5rem; padding: 0.8rem; padding-left: 2.8rem; width: 100%; font-size: 0.95rem; transition: border-color 0.2s, box-shadow 0.2s; color: var(--text-primary); }
        .input-wrapper select:not([multiple]) {
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23A0AEC0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 1.2rem;
        }
        .input-wrapper input:focus, .input-wrapper select:focus { outline: none; border-color: var(--primary); background-color: var(--bg-secondary); }
        .input-wrapper input:focus + .icon, .input-wrapper select:focus + .icon { color: var(--primary); }
        .load-button { width: 100%; padding: 0.8rem; border: none; background-color: var(--primary); color: white; font-weight: 600; border-radius: 0.5rem; cursor: pointer; transition: background-color 0.2s, transform 0.2s; }
        .load-button:hover { background-color: var(--primary-dark); transform: translateY(-2px); }
        
        .custom-select-container { position: relative; }
        .custom-select-display { background-color: var(--input-bg); border: 2px solid transparent; border-radius: 0.5rem; padding: 0.5rem; width: 100%; min-height: 48px; cursor: pointer; display: flex; flex-wrap: wrap; gap: 0.4rem; align-items: center; }
        .custom-select-display.open { border-color: var(--primary); }
        .country-tag { background-color: var(--primary-light); color: var(--primary-dark); padding: 0.25rem 0.6rem; border-radius: 0.25rem; font-size: 0.8rem; font-weight: 500; display: flex; align-items: center; gap: 0.4rem; }
        html[data-theme="dark"] .country-tag { color: var(--primary); }
        .country-tag .remove-tag { cursor: pointer; font-weight: bold; }
        .placeholder-text { color: var(--text-secondary); padding-left: 0.3rem; }
        .country-dropdown { position: absolute; top: 105%; left: 0; width: 100%; background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 1002; padding: 0.5rem; }
        .country-search { width: 100%; padding: 0.7rem; border: 1px solid var(--border-color); border-radius: 0.25rem; margin-bottom: 0.5rem; background-color: var(--bg-primary); color: var(--text-primary); }
        .country-list-actions { padding-bottom: 0.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); }
        .country-list-actions button { width: 100%; padding: 0.5rem; border: none; background-color: var(--primary-light); color: var(--primary-dark); font-weight: 600; border-radius: 0.25rem; cursor: pointer; transition: background-color 0.2s; }
        html[data-theme="dark"] .country-list-actions button { color: var(--primary); }
        .country-list-actions button:hover { background-color: #d8e6ff; }
        html[data-theme="dark"] .country-list-actions button:hover { background-color: #4a5568; }
        .country-list { max-height: 200px; overflow-y: auto; }
        .country-list-item { display: flex; align-items: center; padding: 0.6rem 0.5rem; cursor: pointer; border-radius: 0.25rem; }
        .country-list-item:hover { background-color: var(--bg-primary); }
        .country-list-item input { margin-right: 0.7rem; }
        
        .map-area { flex-grow: 1; position: relative; z-index: 1; background-color: var(--bg-secondary); border-radius: 0.75rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid var(--border-color); overflow: hidden; transition: background-color 0.3s, border-color 0.3s;}
        #map-container { width: 100%; height: 100%; }
        [data-theme="dark"] .leaflet-tile-pane { filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7); }
        .right-panel-wrapper { position: relative; width: 360px; flex-shrink: 0; z-index: 100; }
        .details-panel { width: 100%; height: 100%; background-color: var(--bg-secondary); box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: absolute; right: 0; top: 0; transform: translateX(105%); opacity: 0; pointer-events: none; transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out, background-color 0.3s, border-color 0.3s; display: none; flex-direction: column; border-radius: 0.75rem; border: 1px solid var(--border-color); }
        .details-panel.active { transform: translateX(0); opacity: 1; pointer-events: auto; display: flex; }
        
        .details-image-container {
            width: 100%;
            height: 200px;
            background-color: var(--input-bg);
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            overflow: hidden;
            flex-shrink: 0;
        }
        .details-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .details-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            position: relative;
            flex-shrink: 0;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .details-panel:not(.has-image) .details-header {
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }

        .details-header h2 {
            font-family: 'EB Garamond', serif;
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0;
            margin-right: 2.5rem;
            line-height: 1.2;
        }
        .details-header .sector-tag {
             display: inline-block;
             align-self: flex-start;
             padding: 0.25rem 0.75rem;
             border-radius: 99px;
             font-size: 0.75rem;
             font-weight: 600;
             text-transform: uppercase;
             margin-top: 0.75rem;
             color: white;
             background-color: rgba(255,255,255,0.15);
             border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .close-btn { position: absolute; top: 0.8rem; right: 0.8rem; background: none; border: none; font-size: 1.8rem; color: rgba(255,255,255,0.8); cursor: pointer; line-height: 1; transition: color 0.2s; z-index: 5; }
        .close-btn:hover { color: white; }
        .details-body { padding: var(--space-md); overflow-y: auto; flex: 1; }
        
        .details-footer {
            padding: var(--space-md);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .action-buttons { 
            display: flex; 
            flex-direction: column; 
            gap: 0.75rem; 
        }

        .action-btn { display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.8rem; border-radius: 0.5rem; border: none; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; }
        .btn-wikidata { background-color: var(--primary); color: white; }
        .btn-wikipedia { background-color: var(--green); color: white; }
        .btn-commons { background-color: var(--commons-blue); color: white; }
        .action-btn:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .stats-panel-wrapper { width: 100%; height: 100%; background-color: var(--bg-secondary); border-radius: 0.75rem; padding: var(--space-md); overflow-y: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); flex-shrink: 0; border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s;}
        .stats-panel h2 { font-size: 1.1rem; margin-bottom: var(--space-md); color: var(--primary); display: flex; align-items: center; gap: 0.5rem; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-lg); }
        .stat-card { display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-sm); background-color: var(--bg-secondary); border-radius: 0.5rem; border-left: 4px solid; }
        .stat-icon { font-size: 1.2rem; flex-shrink: 0; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; }
        .stat-info { display: flex; flex-direction: column; align-items: flex-start; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }
        .stat-label { font-size: 0.8rem; color: var(--text-secondary); }
        .stat-total { border-color: var(--primary); }
        .stat-total .stat-icon { background-color: var(--primary); }
        .stat-active { border-color: var(--accent); }
        .stat-active .stat-icon { background-color: var(--accent); }
        .stat-latent { border-color: var(--orange); }
        .stat-latent .stat-icon { background-color: var(--orange); }
        .stat-resolved { border-color: var(--green); }
        .stat-resolved .stat-icon { background-color: var(--green); }

        .sector-chart { margin-top: var(--space-md); }
        .sector-item { display: flex; align-items: center; margin-bottom: 1.2rem; }
        .sector-icon-wrapper { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: var(--space-sm); flex-shrink: 0; }
        .sector-icon { color: white; font-size: 1rem; }
        .sector-content { flex: 1; display: flex; flex-direction: column; }
        .sector-label { font-size: 0.9rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.3rem; }
        .sector-bar-wrapper { display: flex; align-items: center; width: 100%; }
        .sector-bar-container { flex-grow: 1; background-color: var(--border-color); border-radius: 5px; height: 8px; overflow: hidden; margin-right: 0.5rem; }
        .sector-bar { height: 100%; border-radius: 5px; transition: width 0.8s ease-out; }
        .percentage-value { font-weight: 600; color: var(--text-primary); font-size: 0.85rem; min-width: 35px; text-align: right; }
        
        .details-status-banner { padding: var(--space-sm) var(--space-md); margin-bottom: var(--space-lg); border-radius: 0.5rem; display: flex; align-items: center; gap: var(--space-sm); font-weight: 600; font-size: 1rem; border-left-width: 5px; border-left-style: solid; }
        .details-status-banner .icon { font-size: 1.2rem; }
        .status-Activo { background-color: hsl(4, 79%, 96%); color: hsl(4, 79%, 40%); border-color: hsl(4, 79%, 60%); }
        .status-Latente { background-color: hsl(35, 100%, 96%); color: hsl(35, 100%, 35%); border-color: hsl(35, 100%, 50%); }
        .status-Resuelto { background-color: hsl(162, 100%, 96%); color: hsl(162, 100%, 25%); border-color: hsl(162, 100%, 35%); }
        .status-Desconocido { background-color: hsl(210, 8%, 96%); color: hsl(210, 8%, 40%); border-color: hsl(210, 8%, 60%); }
        
        [data-theme="dark"] .status-Activo { background-color: #312424; color: #f56565; border-color: #e53e3e; }
        [data-theme="dark"] .status-Latente { background-color: #332b21; color: #ed8936; border-color: #dd6b20; }
        [data-theme="dark"] .status-Resuelto { background-color: #23312c; color: #48bb78; border-color: #38a169; }
        [data-theme="dark"] .status-Desconocido { background-color: #30353c; color: #a0aec0; border-color: #718096; }

        .details-description { font-size: 0.95rem; line-height: 1.7; color: var(--text-primary); margin-bottom: var(--space-lg); border-bottom: 1px solid var(--border-color); padding-bottom: var(--space-lg); }
        .details-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); }
        .info-item { display: flex; align-items: flex-start; gap: var(--space-sm); }
        .info-item .icon { font-size: 1.1rem; color: var(--primary); margin-top: 0.15rem; }
        .info-item .content label { font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.2rem; display: block; }
        .info-item .content .value { font-size: 0.95rem; font-weight: 500; color: var(--text-primary); }
        
        .tutorial-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 10000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .tutorial-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .tutorial-highlight-box {
            position: fixed; 
            border-radius: 0.75rem;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
            z-index: 10001;
            transition: all 0.4s ease-in-out;
            pointer-events: none;
        }
        .tutorial-popup {
            position: fixed;
            background-color: var(--bg-secondary);
            padding: var(--space-lg);
            border-radius: 0.75rem;
            border-top: 4px solid var(--primary);
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            width: 320px;
            z-index: 10002;
            transition: all 0.4s ease-in-out;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .tutorial-popup h3 { 
            color: var(--primary); 
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.2rem;
        }
        .tutorial-popup p { font-size: 0.95rem; color: var(--text-secondary); line-height: 1.6; }
        .tutorial-nav { margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .tutorial-dots { display: flex; gap: 0.5rem; }
        .dot { width: 10px; height: 10px; background-color: var(--border-color); border-radius: 50%; transition: background-color 0.3s; }
        .dot.active { background-color: var(--primary); }
        .tutorial-nav button { background: var(--primary); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 0.5rem; cursor: pointer; font-weight: 600; transition: all 0.2s ease; }
        .tutorial-nav button:hover:not(:disabled) { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .tutorial-nav button:disabled { background-color: var(--text-secondary); cursor: not-allowed; }

        .welcome-modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 11000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .welcome-modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .welcome-modal {
            background: var(--bg-secondary);
            padding: 2.5rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 450px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .welcome-modal-overlay.active .welcome-modal {
            transform: scale(1);
        }
        .welcome-modal .icon {
            font-size: 3.5rem;
            color: var(--primary);
            margin-bottom: 1rem;
            line-height: 1;
        }
        .welcome-modal h2 {
            font-family: 'EB Garamond', serif;
            font-size: 2.2rem;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }
        .welcome-modal p {
            color: var(--text-secondary);
            font-size: 1.05rem;
            line-height: 1.7;
            margin-bottom: 2rem;
        }
        .welcome-modal button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 0.9rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(51, 102, 204, 0.4);
        }
        .welcome-modal button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(51, 102, 204, 0.5);
        }

        footer { background-color: var(--bg-secondary); border-top: 1px solid var(--border-color); padding: var(--space-md) 0; flex-shrink: 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); transition: background-color 0.3s, border-color 0.3s;}
        .footer-container { max-width: 1400px; margin: 0 auto; padding: 0 var(--space-lg); text-align: center; color: var(--text-secondary); }
        .footer-logos { display: flex; justify-content: center; align-items: center; gap: var(--space-lg); margin-bottom: var(--space-sm); }
        .footer-logos img { height: 40px; width: auto; }
        [data-theme="dark"] .footer-logos img { filter: invert(1) opacity(0.8); }
        .footer-text { font-size: 0.9rem; margin-bottom: 0.5rem; }
        .footer-copyright { font-size: 0.8rem; }
        .loading { display: flex; justify-content: center; align-items: center; height: 100%; font-size: 1.2rem; color: var(--text-secondary); position: absolute; width: 100%; background-color: rgba(0,0,0,0.5); z-index: 10; border-radius: 0.75rem; }
        .loading::after { content: ""; width: 24px; height: 24px; border: 3px solid var(--border-color); border-top: 3px solid var(--primary); border-radius: 50%; margin-left: 12px; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .message { padding: var(--space-sm) var(--space-md); text-align: center; background-color: var(--primary-light); border-radius: 0.75rem; color: var(--primary); border-left: 4px solid var(--primary); position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1001; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        @media (max-width: 1200px) {
            .map-and-panels-wrapper { flex-direction: column; height: auto; min-height: unset; }
            .filters-panel, .right-panel-wrapper, .map-area { width: 100%; height: auto; }
            .map-area { height: 60vh; min-height: 450px; }
            .details-panel { position: relative; transform: none; opacity: 1; pointer-events: auto; max-height: 85vh; }
        }
        @media (max-width: 768px) { .main-container { padding: var(--space-sm); } .header { flex-direction: column; gap: 0.5rem; text-align: center; } .header-left { justify-content: center; } .header-right { margin-top: 1rem; } }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <!-- El contenido se renderizar√° aqu√≠ por Vue -->
    </div>

    <!-- Carga de Leaflet ANTES de la app Vue -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <!-- Carga de Vue 3 -->
    <script type="importmap">
    {
        "imports": {
            "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js"
        }
    }
    </script>

    <script type="module">
        import { createApp, ref, reactive, onMounted, onBeforeUnmount, watch, computed, nextTick } from 'vue';

        // La plantilla HTML de la aplicaci√≥n completa
        const AppTemplate = `
            <div :class="['tutorial-overlay', { active: isTutorialActive }]">
                <div v-if="isTutorialActive">
                    <div class="tutorial-highlight-box" :style="tutorialHighlightStyle"></div>
                    <div class="tutorial-popup" :style="tutorialPopupStyle">
                        <h3><i class="fas fa-route"></i> {{ currentTutorialStep.title }}</h3>
                        <p>{{ currentTutorialStep.text }}</p>
                        <div class="tutorial-nav">
                            <div class="tutorial-dots">
                                <span v-for="(step, index) in tutorialSteps" :key="index" class="dot" :class="{ active: index === tutorialStep }"></span>
                            </div>
                            <div>
                                <button @click="prevStep" :disabled="tutorialStep === 0">{{ t('tutorial.previous') }}</button>
                                <button @click="nextStep" v-if="tutorialStep < tutorialSteps.length - 1">{{ t('tutorial.next') }}</button>
                                <button @click="finishTutorial" v-else>{{ t('tutorial.finish') }}</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div :class="['welcome-modal-overlay', { active: showWelcomeModal }]">
                <div class="welcome-modal">
                    <div class="icon">üó∫Ô∏è</div>
                    <h2>{{ t('welcome.title') }}</h2>
                    <p>{{ t('welcome.message') }}</p>
                    <button @click="closeWelcomeModal">{{ t('welcome.button') }}</button>
                </div>
            </div>

            <header class="header">
                 <div class="header-left">
                    <div class="logo-container">
                        <img src="/logo.png" alt="Logo Wikimedia Chile">
                    </div>
                    <div class="title-group">
                        <h1 class="logo-title">{{ t('header.title') }}</h1>
                        <p class="logo-subtitle">{{ t('header.subtitle') }}</p>
                    </div>
                 </div>
                 <div class="header-right">
                     <div class="lang-switcher" ref="langSwitcherContainer">
                        <button @click="isLangDropdownOpen = !isLangDropdownOpen" class="lang-switcher-btn">
                            <i class="fas fa-globe"></i>
                            <span>{{ supportedLangs[currentLang] }}</span>
                            <i class="fas fa-chevron-down" style="font-size: 0.8em; margin-left: 0.3rem;"></i>
                        </button>
                        <ul class="lang-dropdown" v-if="isLangDropdownOpen">
                            <li v-for="(name, code) in supportedLangs" @click="changeLanguage(code)">{{ name }}</li>
                        </ul>
                     </div>
                     <button @click="toggleTheme" class="theme-switcher-btn" :aria-label="t('theme.toggle')">
                        <i class="fas" :class="theme === 'light' ? 'fa-moon' : 'fa-sun'"></i>
                     </button>
                 </div>
            </header>

            <div class="main-container">
                <div class="map-and-panels-wrapper">
                    <div id="filters-panel" class="filters-panel">
                        <h2><i class="fas fa-filter"></i> {{ t('filters.title') }}</h2>
                        <div class="filter-group">
                            <label for="country-filter">{{ t('filters.country') }}</label>
                             <div class="custom-select-container" ref="countrySelectContainer">
                                 <div class="custom-select-display" @click="isCountryDropdownOpen = !isCountryDropdownOpen" :class="{ open: isCountryDropdownOpen }">
                                     <span v-if="filters.country.length === 0" class="placeholder-text">{{ t('filters.selectCountries') }}</span>
                                     <div v-for="countryId in filters.country" :key="countryId" class="country-tag">
                                         <span>{{ getCountryName(countryId) }}</span>
                                         <span class="remove-tag" @click.stop="removeCountry(countryId)">&times;</span>
                                     </div>
                                 </div>
                                 <div class="country-dropdown" v-show="isCountryDropdownOpen">
                                     <input type="text" class="country-search" v-model="countrySearchTerm" :placeholder="t('filters.searchCountry')">
                                     <div class="country-list-actions">
                                        <button @click.stop="toggleSelectAllCountries">{{ selectAllButtonText }}</button>
                                     </div>
                                     <div class="country-list">
                                         <label v-for="country in filteredCountries" :key="country.id" class="country-list-item">
                                             <input type="checkbox" :value="country.id" v-model="filters.country">
                                             {{ country.name }}
                                         </label>
                                     </div>
                                 </div>
                             </div>
                        </div>
                        <div class="filter-group">
                            <button class="load-button" @click="onCountryChange">{{ t('filters.viewConflicts') }}</button>
                        </div>
                        <div class="filter-group">
                            <label for="search">{{ t('filters.searchByName') }}</label>
                            <div class="input-wrapper">
                                <input type="text" id="search" :placeholder="t('filters.searchPlaceholder')" v-model="filters.search">
                                <i class="fas fa-search icon"></i>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="region-filter">{{ t('filters.region') }}</label>
                            <div class="input-wrapper">
                                <select id="region-filter" v-model="filters.region" :disabled="filterOptions.regions.length === 0">
                                     <option value="">{{ t('filters.allRegions') }}</option>
                                     <option v-for="region in filterOptions.regions" :key="region" :value="region">{{ region }}</option>
                                </select>
                                <i class="fas fa-map-marked-alt icon"></i>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="type-filter">{{ t('filters.sector') }}</label>
                            <div class="input-wrapper">
                               <select id="type-filter" v-model="filters.sector" :disabled="filterOptions.sectors.length === 0">
                                   <option value="">{{ t('filters.allSectors') }}</option>
                                   <option v-for="sector in filterOptions.sectors" :key="sector" :value="sector">{{ t('sectors.' + sector) }}</option>
                               </select>
                               <i class="fas fa-industry icon"></i>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="status-filter">{{ t('filters.status') }}</label>
                            <div class="input-wrapper">
                                <select id="status-filter" v-model="filters.status">
                                    <option value="">{{ t('filters.allStatuses') }}</option>
                                    <option value="Activo">{{ t('statuses.activo') }}</option>
                                    <option value="Latente">{{ t('statuses.latente') }}</option>
                                    <option value="Resuelto">{{ t('statuses.resuelto') }}</option>
                                    <option value="Desconocido">{{ t('statuses.desconocido') }}</option>
                                </select>
                                <i class="fas fa-lightbulb icon"></i>
                            </div>
                        </div>
                         <div class="filter-group">
                            <label for="date-filter">{{ t('filters.startDate') }}</label>
                            <div class="input-wrapper">
                               <input type="date" id="date-filter" v-model="filters.date">
                               <i class="fas fa-calendar-alt icon"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="map-area" id="map-area">
                        <div id="map-container" ref="mapContainer"></div>
                        <div class="loading" v-if="isLoading">
                            {{ t('loading') }}
                        </div>
                    </div>
                    
                     <div class="right-panel-wrapper" id="stats-panel">
                         <div class="stats-panel-wrapper" v-show="!activeConflict">
                             <div class="stats-panel">
                                 <h2><i class="fas fa-chart-bar"></i> {{ t('stats.title') }}</h2>
                                 <div class="stats-grid">
                                     <div class="stat-card stat-total">
                                         <div class="stat-icon"><i class="fas fa-globe-americas"></i></div>
                                         <div class="stat-info"><div class="stat-value">{{ stats.total }}</div><div class="stat-label">{{ t('stats.total') }}</div></div>
                                     </div>
                                     <div class="stat-card stat-active">
                                         <div class="stat-icon"><i class="fas fa-fire-alt"></i></div>
                                         <div class="stat-info"><div class="stat-value">{{ stats.active }}</div><div class="stat-label">{{ t('stats.active') }}</div></div>
                                     </div>
                                     <div class="stat-card stat-latent">
                                         <div class="stat-icon"><i class="fas fa-hourglass-half"></i></div>
                                         <div class="stat-info"><div class="stat-value">{{ stats.latent }}</div><div class="stat-label">{{ t('stats.latent') }}</div></div>
                                     </div>
                                     <div class="stat-card stat-resolved">
                                         <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                                         <div class="stat-info"><div class="stat-value">{{ stats.resolved }}</div><div class="stat-label">{{ t('stats.resolved') }}</div></div>
                                     </div>
                                 </div>
                                 <h3><i class="fas fa-industry"></i> {{ t('stats.sectorDistribution') }}</h3>
                                 <div class="sector-chart">
                                     <div class="sector-item" v-for="sector in stats.sectors" :key="sector.name">
                                         <div class="sector-icon-wrapper" :style="{ backgroundColor: sector.color }"><i :class="sector.icon" class="sector-icon"></i></div>
                                         <div class="sector-content">
                                             <div class="sector-label">{{ t('sectors.' + sector.name) }}</div>
                                             <div class="sector-bar-wrapper">
                                                 <div class="sector-bar-container">
                                                     <div class="sector-bar" :style="{ width: sector.percentage + '%', backgroundColor: sector.color }"></div>
                                                 </div>
                                                 <span class="percentage-value">{{ sector.percentage }}%</span>
                                             </div>
                                         </div>
                                     </div>
                                 </div>
                               </div>
                         </div>

                         <div class="details-panel" :class="{ active: activeConflict, 'has-image': activeConflict && activeConflict.imageUrl }">
                             <div v-if="activeConflict" style="display: flex; flex-direction: column; height: 100%;">
                                 <div v-if="activeConflict.imageUrl" class="details-image-container">
                                     <img :src="activeConflict.imageUrl" :alt="t('details.imageAlt') + ' ' + activeConflict.name" @error="onImageError">
                                 </div>
                                 <div class="details-header">
                                     <button class="close-btn" @click="activeConflict = null">&times;</button>
                                     <h2>{{ activeConflict.name }}</h2>
                                     <span class="sector-tag" :style="{ backgroundColor: getSectorColor(activeConflict.sector) }">{{ t('sectors.' + activeConflict.sector) }}</span>
                                 </div>
                                 <div class="details-body">
                                     <div :class="['details-status-banner', 'status-' + activeConflict.status]">
                                         <i :class="['fas', getStatusInfo(activeConflict.status).icon, 'icon']"></i>
                                         <span>{{ getStatusInfo(activeConflict.status).text }}</span>
                                     </div>
                                     <div class="details-description" v-html="activeConflict.description"></div>
                                     <div class="details-info-grid">
                                         <div class="info-item">
                                             <i class="fas fa-map-marked-alt icon"></i>
                                             <div class="content">
                                                 <label>{{ t('details.location') }}</label>
                                                 <span class="value">{{ activeConflict.region }} <span v-if="activeConflict.isImprecise">{{ t('details.approximate') }}</span></span>
                                             </div>
                                         </div>
                                         <div class="info-item">
                                             <i class="fas fa-calendar-alt icon"></i>
                                             <div class="content">
                                                 <label>{{ t('details.startDate') }}</label>
                                                 <span class="value">{{ formatDate(activeConflict.startDate) }}</span>
                                             </div>
                                         </div>
                                     </div>
                                 </div>
                                 <div class="details-footer">
                                     <div class="action-buttons">
                                         <button class="action-btn btn-wikidata" @click="openLink('https://www.wikidata.org/wiki/' + activeConflict.id)"><i class="fas fa-database"></i> {{ t('details.viewOnWikidata') }}</button>
                                         <button v-if="activeConflict.wikipediaUrl" class="action-btn btn-wikipedia" @click="openLink(activeConflict.wikipediaUrl)"><i class="fab fa-wikipedia-w"></i> {{ t('details.viewOnWikipedia') }}</button>
                                         <button v-if="activeConflict.commonsUrl" class="action-btn btn-commons" @click="openLink(activeConflict.commonsUrl)"><i class="fas fa-images"></i> {{ t('details.viewOnCommons') }}</button>
                                     </div>
                                 </div>
                               </div>
                         </div>
                       </div>
                </div>
            </div>
            
            <footer>
                <div class="footer-container">
                    <div class="footer-logos">
                        <a href="https://www.wikimedia.cl/" target="_blank" rel="noopener noreferrer"><img src="wikiemdia foundation logo.webp" alt="Logo Wikimedia Chile"></a>
                        <a href="https://www.wikidata.org/" target="_blank" rel="noopener noreferrer"><img src="wikidata logo.png" alt="Logo Wikidata"></a>
                    </div>
                    <p class="footer-text">{{ t('footer.text') }}</p>
                    <p class="footer-copyright">¬© {{ new Date().getFullYear() }} {{ t('footer.copyright') }}</p>
                </div>
            </footer>
        `;

        createApp({
            template: AppTemplate,
            setup() {
                // --- DEFINICIONES Y CONSTANTES ---
                const QID_CHILE = "Q298";
                const sectorKeywords = {
                    es: { 'Minero': ["minero", "minera", "mina", "pascua lama", "casale", "collahuasi", "codelco", "cobre", "litio"], 'Agua': ["agua", "h√≠drico", "represa", "r√≠o", "lago", "hidroel√©ctrica", "hidroays√©n", "escasez", "glaciar", "sequ√≠a", "embalse", "mar", "oc√©ano", "costa", "puerto"], 'Forestal': ["forestal", "celulosa", "arauco", "cmpc", "bosque", "√°rbol", "plantaci√≥n"], 'Industrial': ["industrial", "contaminaci√≥n", "quintero", "refiner√≠a", "plomo", "pesquero", "salmonera", "derrame", "empresa"], 'Energ√©tico': ["energ√©tico", "termoel√©ctrica", "central", "carb√≥n", "e√≥lico", "el√©ctrica", "solar", "gas", "petr√≥leo"], 'Protesta Social': ["protesta", "social", "estallido", "huelga", "disputa", "movilizaci√≥n", "comunidad", "vecinos", "mapuche"] },
                    en: { 'Minero': ["mine", "mining", "copper", "lithium", "codelco", "pascua lama"], 'Agua': ["water", "dam", "river", "lake", "hydroelectric", "shortage", "glacier", "drought", "reservoir", "sea", "ocean", "coast", "port"], 'Forestal': ["forestry", "pulp", "forest", "tree", "plantation"], 'Industrial': ["industrial", "pollution", "refinery", "lead", "fishing", "salmon", "spill", "factory"], 'Energ√©tico': ["energy", "thermoelectric", "power plant", "coal", "wind", "electric", "solar", "gas", "oil"], 'Protesta Social': ["protest", "social", "strike", "dispute", "mobilization", "community", "neighbors"] },
                    it: { 'Minero': ["miniera", "estrazione", "rame", "litio"], 'Agua': ["acqua", "diga", "fiume", "lago", "idroelettrico", "siccit√†", "ghiacciaio", "serbatoio", "mare", "oceano", "costa", "porto"], 'Forestal': ["forestale", "cellulosa", "foresta", "albero", "piantagione"], 'Industrial': ["industriale", "inquinamento", "raffineria", "piombo", "pesca", "salmone", "versamento", "fabbrica"], 'Energ√©tico': ["energia", "termoelettrico", "centrale", "carbone", "eolico", "elettrico", "solare", "gas", "petrolio"], 'Protesta Social': ["protesta", "sociale", "sciopero", "disputa", "mobilitazione", "comunit√†"] },
                    ja: { 'Minero': ["Èâ±Â±±", "Èâ±Ê•≠", "ÈäÖ", "„É™„ÉÅ„Ç¶„É†"], 'Agua': ["Ê∞¥", "„ÉÄ„É†", "Â∑ù", "Êπñ", "Ê∞¥ÂäõÁô∫Èõª", "Âπ≤„Å∞„Å§", "Ê∞∑Ê≤≥", "Ë≤ØÊ∞¥Ê±†", "Êµ∑", "Êµ∑Â≤∏", "Ê∏Ø"], 'Forestal': ["ÊûóÊ•≠", "„Éë„É´„Éó", "Ê£ÆÊûó", "Ê§çÊûó"], 'Industrial': ["Áî£Ê•≠", "Ê±öÊüì", "Ë£ΩÊ≤πÊâÄ", "Èâõ", "ÊºÅÊ•≠", "„Çµ„Ç±", "ÊµÅÂá∫", "Â∑•Â†¥"], 'Energ√©tico': ["„Ç®„Éç„É´„ÇÆ„Éº", "ÁÅ´ÂäõÁô∫ÈõªÊâÄ", "Áü≥ÁÇ≠", "È¢®Âäõ", "ÈõªÊ∞ó", "Â§™ÈôΩÂÖâ", "„Ç¨„Çπ", "Áü≥Ê≤π"], 'Protesta Social': ["ÊäóË≠∞", "Á§æ‰ºö", "„Çπ„Éà„É©„Ç§„Ç≠", "Á¥õ‰∫â", "ÂãïÂì°", "„Ç≥„Éü„É•„Éã„ÉÜ„Ç£"] },
                    pt: { 'Minero': ["minera√ß√£o", "mina", "cobre", "l√≠tio"], 'Agua': ["√°gua", "represa", "rio", "lago", "hidrel√©trica", "escassez", "geleira", "seca", "reservat√≥rio", "mar", "oceano", "costa", "porto"], 'Forestal': ["florestal", "celulose", "floresta", "√°rvore", "planta√ß√£o"], 'Industrial': ["industrial", "polui√ß√£o", "refinaria", "chumbo", "pesca", "salm√£o", "derramamento", "f√°brica"], 'Energ√©tico': ["energia", "termoel√©trica", "central", "carv√£o", "e√≥lica", "el√©trica", "solar", "g√°s", "petr√≥leo"], 'Protesta Social': ["protesto", "social", "greve", "disputa", "mobiliza√ß√£o", "comunidade"] },
                    fr: { 'Minero': ["mine", "minier", "cuivre", "lithium"], 'Agua': ["eau", "barrage", "rivi√®re", "lac", "hydro√©lectrique", "p√©nurie", "glacier", "s√©cheresse", "r√©servoir", "mer", "oc√©an", "c√¥te", "port"], 'Forestal': ["for√™t", "forestier", "cellulose", "plantation"], 'Industrial': ["industriel", "pollution", "raffinerie", "plomb", "p√™che", "saumon", "d√©versement", "usine"], 'Energ√©tico': ["√©nergie", "thermo√©lectrique", "centrale", "charbon", "√©olien", "√©lectrique", "solaire", "gaz", "p√©trole"], 'Protesta Social': ["protestation", "social", "gr√®ve", "conflit", "mobilisation", "communaut√©"] },
                    de: { 'Minero': ["bergbau", "mine", "kupfer", "lithium"], 'Agua': ["wasser", "staudamm", "fluss", "see", "wasserkraft", "knappheit", "gletscher", "d√ºrre", "stausee", "meer", "ozean", "k√ºste", "hafen"], 'Forestal': ["forstwirtschaft", "wald", "zellstoff", "plantage"], 'Industrial': ["industrie", "verschmutzung", "raffinerie", "blei", "fischerei", "lachs", "leck", "fabrik"], 'Energ√©tico': ["energie", "w√§rmekraftwerk", "kraftwerk", "kohle", "wind", "strom", "solar", "gas", "√∂l"], 'Protesta Social': ["protest", "sozial", "streik", "streit", "mobilisierung", "gemeinschaft"] }
                };
                const sectorColors = { 'Minero': "#ff9800", 'Agua': "#2196f3", 'Forestal': "#4caf50", 'Industrial': "#f44336", 'Energ√©tico': "#9c27b0", 'Protesta Social': "#e91e63", 'Otro': "#607d8b" };
                const sectorIcons = { 'Minero': "fas fa-mountain", 'Agua': "fas fa-water", 'Forestal': "fas fa-tree", 'Industrial': "fas fa-industry", 'Energ√©tico': "fas fa-bolt", 'Protesta Social': "fas fa-users", 'Otro': "fas fa-question-circle" };
                
                // --- INTERNACIONALIZACI√ìN (i18n) ---
                const supportedLangs = reactive({
                    'es': 'Espa√±ol',
                    'en': 'English',
                    'it': 'Italiano',
                    'ja': 'Êó•Êú¨Ë™û',
                    'pt': 'Portugu√™s',
                    'fr': 'Fran√ßais',
                    'de': 'Deutsch'
                });
                const currentLang = ref('es');
                const isLangDropdownOpen = ref(false);
                const langSwitcherContainer = ref(null);

                const translations = {
                    es: {
                        header: { title: 'GeoConflictos', subtitle: 'Mapa de conflictos socioambientales' },
                        filters: { title: 'Filtros', country: 'Pa√≠s', selectCountries: 'Seleccionar pa√≠ses...', searchCountry: 'Buscar pa√≠s...', viewConflicts: 'Ver Conflictos', searchByName: 'Buscar por nombre', searchPlaceholder: 'Ej: Pascua Lama...', region: 'Regi√≥n', allRegions: 'Todas las regiones', sector: 'Sector', allSectors: 'Todos los sectores', status: 'Estado', allStatuses: 'Todos los estados', startDate: 'Fecha de inicio' },
                        statuses: { activo: 'Activo', latente: 'Latente', resuelto: 'Resuelto', desconocido: 'Desconocido' },
                        sectors: { 'Minero': 'Minero', 'Agua': 'Agua', 'Forestal': 'Forestal', 'Industrial': 'Industrial', 'Energ√©tico': 'Energ√©tico', 'Protesta Social': 'Protesta Social', 'Otro': 'Otro' },
                        loading: 'Consultando Wikidata...',
                        stats: { title: 'Estad√≠sticas', total: 'Total', active: 'Activos', latent: 'Latentes', resolved: 'Resueltos', sectorDistribution: 'Distribuci√≥n por Sector' },
                        details: { location: 'Ubicaci√≥n', approximate: '(aprox.)', startDate: 'Fecha de inicio', viewOnWikidata: 'Ver en Wikidata', viewOnWikipedia: 'Ver en Wikipedia', viewOnCommons: 'Ver en Commons', noName: 'Sin nombre', noDescription: 'Sin descripci√≥n', imageAlt: 'Imagen de' },
                        statusInfo: { Activo: { icon: 'fa-fire-alt', text: 'Conflicto Activo' }, Latente: { icon: 'fa-hourglass-half', text: 'Conflicto Latente' }, Resuelto: { icon: 'fa-check-circle', text: 'Conflicto Resuelto' }, Desconocido: { icon: 'fa-question-circle', text: 'Estado Desconocido' } },
                        tutorial: { step1: { title: 'Panel de Filtros', text: 'Aqu√≠ puedes filtrar los conflictos por pa√≠s, nombre, sector y m√°s. Selecciona uno o varios pa√≠ses y presiona "Ver Conflictos" para empezar.' }, step2: { title: 'Mapa Interactivo', text: 'Los conflictos aparecer√°n aqu√≠. Los puntos con borde discontinuo indican una ubicaci√≥n aproximada. Haz clic en un punto para ver m√°s detalles.' }, step3: { title: 'Estad√≠sticas y Detalles', text: 'Este panel muestra un resumen de los conflictos visualizados. Al seleccionar un conflicto en el mapa, aqu√≠ ver√°s su informaci√≥n detallada.' }, previous: 'Anterior', next: 'Siguiente', finish: 'Finalizar' },
                        welcome: { title: 'Exploraci√≥n Iniciada', message: '¬°Todo listo! Ya puedes navegar, filtrar y descubrir los conflictos socioambientales. ¬°Que tu curiosidad sea tu gu√≠a!', button: 'Comenzar a Explorar' },
                        footer: { text: 'Desarrollado con datos de Wikidata, un proyecto de la Fundaci√≥n Wikimedia.', copyright: 'Wikimedia Chile. Contenido disponible bajo licencia CC BY-SA 4.0.' },
                        selectAll: 'Seleccionar todos',
                        deselectAll: 'Deseleccionar todos',
                        theme: { toggle: 'Cambiar tema' }
                    },
                    en: {
                        header: { title: 'GeoConflicts', subtitle: 'Map of socio-environmental conflicts' },
                        filters: { title: 'Filters', country: 'Country', selectCountries: 'Select countries...', searchCountry: 'Search country...', viewConflicts: 'View Conflicts', searchByName: 'Search by name', searchPlaceholder: 'E.g., Pascua Lama...', region: 'Region', allRegions: 'All regions', sector: 'Sector', allSectors: 'All sectors', status: 'Status', allStatuses: 'All statuses', startDate: 'Start date' },
                        statuses: { activo: 'Active', latente: 'Latent', resuelto: 'Resolved', desconocido: 'Unknown' },
                        sectors: { 'Minero': 'Mining', 'Agua': 'Water', 'Forestal': 'Forestry', 'Industrial': 'Industrial', 'Energ√©tico': 'Energy', 'Protesta Social': 'Social Protest', 'Otro': 'Other' },
                        loading: 'Querying Wikidata...',
                        stats: { title: 'Statistics', total: 'Total', active: 'Active', latent: 'Latent', resolved: 'Resolved', sectorDistribution: 'Distribution by Sector' },
                        details: { location: 'Location', approximate: '(approx.)', startDate: 'Start Date', viewOnWikidata: 'View on Wikidata', viewOnWikipedia: 'View on Wikipedia', viewOnCommons: 'View on Commons', noName: 'No name', noDescription: 'No description', imageAlt: 'Image of' },
                        statusInfo: { Activo: { icon: 'fa-fire-alt', text: 'Active Conflict' }, Latente: { icon: 'fa-hourglass-half', text: 'Latent Conflict' }, Resuelto: { icon: 'fa-check-circle', text: 'Resolved Conflict' }, Desconocido: { icon: 'fa-question-circle', text: 'Unknown Status' } },
                        tutorial: { step1: { title: 'Filter Panel', text: 'Here you can filter conflicts by country, name, sector, and more. Select one or more countries and press "View Conflicts" to begin.' }, step2: { title: 'Interactive Map', text: 'Conflicts will appear here. Dashed border points indicate an approximate location. Click on a point for more details.' }, step3: { title: 'Statistics & Details', text: 'This panel shows a summary of the displayed conflicts. When you select a conflict on the map, its detailed information will appear here.' }, previous: 'Previous', next: 'Next', finish: 'Finish' },
                        welcome: { title: 'Exploration Started', message: 'All set! You can now browse, filter, and discover socio-environmental conflicts. Let your curiosity be your guide!', button: 'Start Exploring' },
                        footer: { text: 'Developed with data from Wikidata, a Wikimedia Foundation project.', copyright: 'Wikimedia Chile. Content available under a CC BY-SA 4.0 license.' },
                        selectAll: 'Select All',
                        deselectAll: 'Deselect All',
                        theme: { toggle: 'Toggle theme' }
                    },
                    it: {
                        header: { title: 'GeoConflitti', subtitle: 'Mappa dei conflitti socio-ambientali' },
                        filters: { title: 'Filtri', country: 'Paese', selectCountries: 'Seleziona paesi...', searchCountry: 'Cerca paese...', viewConflicts: 'Mostra Conflitti', searchByName: 'Cerca per nome', searchPlaceholder: 'Es: TAV...', region: 'Regione', allRegions: 'Tutte le regioni', sector: 'Settore', allSectors: 'Tutti i settori', status: 'Stato', allStatuses: 'Tutti gli stati', startDate: 'Data di inizio' },
                        statuses: { activo: 'Attivo', latente: 'Latente', resuelto: 'Risolto', sconosciuto: 'Sconosciuto' },
                        sectors: { 'Minero': 'Minerario', 'Agua': 'Acqua', 'Forestal': 'Forestale', 'Industrial': 'Industriale', 'Energ√©tico': 'Energia', 'Protesta Social': 'Protesta Sociale', 'Otro': 'Altro' },
                        loading: 'Interrogazione di Wikidata...',
                        stats: { title: 'Statistiche', total: 'Totale', active: 'Attivi', latent: 'Latenti', resolved: 'Risolti', sectorDistribution: 'Distribuzione per Settore' },
                        details: { location: 'Posizione', approximate: '(appross.)', startDate: 'Data di inizio', viewOnWikidata: 'Vedi su Wikidata', viewOnWikipedia: 'Vedi su Wikipedia', viewOnCommons: 'Vedi su Commons', noName: 'Senza nome', noDescription: 'Nessuna descrizione', imageAlt: 'Immagine di' },
                        statusInfo: { Activo: { icon: 'fa-fire-alt', text: 'Conflitto Attivo' }, Latente: { icon: 'fa-hourglass-half', text: 'Conflitto Latente' }, Resuelto: { icon: 'fa-check-circle', text: 'Conflitto Risolto' }, Desconocido: { icon: 'fa-question-circle', text: 'Stato Sconosciuto' } },
                        tutorial: { step1: { title: 'Pannello Filtri', text: 'Qui puoi filtrare i conflitti per paese, nome, settore e altro. Seleziona uno o pi√π paesi e premi "Mostra Conflitti" per iniziare.' }, step2: { title: 'Mappa Interattiva', text: 'I conflitti appariranno qui. I punti con bordo tratteggiato indicano una posizione approssimativa. Clicca su un punto per maggiori dettagli.' }, step3: { title: 'Statistiche e Dettagli', text: 'Questo pannello mostra un riepilogo dei conflitti visualizzati. Selezionando un conflitto sulla mappa, qui vedrai le sue informazioni dettagliate.' }, previous: 'Precedente', next: 'Successivo', finish: 'Fine' },
                        welcome: { title: 'Esplorazione Iniziata', message: 'Tutto pronto! Ora puoi navigare, filtrare e scoprire i conflitti socio-ambientali. Lascia che la tua curiosit√† sia la tua guida!', button: 'Inizia a Esplorare' },
                        footer: { text: 'Sviluppato con dati da Wikidata, un progetto della Wikimedia Foundation.', copyright: 'Wikimedia Chile. Contenuto disponibile con licenza CC BY-SA 4.0.' },
                        selectAll: 'Seleziona tutto',
                        deselectAll: 'Deseleziona tutto',
                        theme: { toggle: 'Cambia tema' }
                    },
                    ja: {
                        header: { title: 'GeoConflict', subtitle: 'Á§æ‰ºöÁí∞Â¢ÉÁ¥õ‰∫â„Éû„ÉÉ„Éó' },
                        filters: { title: '„Éï„Ç£„É´„Çø„Éº', country: 'ÂõΩ', selectCountries: 'ÂõΩ„ÇíÈÅ∏Êäû...', searchCountry: 'ÂõΩ„ÇíÊ§úÁ¥¢...', viewConflicts: 'Á¥õ‰∫â„ÇíË°®Á§∫', searchByName: 'ÂêçÂâç„ÅßÊ§úÁ¥¢', searchPlaceholder: '‰æãÔºöËæ∫ÈáéÂè§...', region: 'Âú∞Âüü', allRegions: '„Åô„Åπ„Å¶„ÅÆÂú∞Âüü', sector: '„Çª„ÇØ„Çø„Éº', allSectors: '„Åô„Åπ„Å¶„ÅÆ„Çª„ÇØ„Çø„Éº', status: '„Çπ„ÉÜ„Éº„Çø„Çπ', allStatuses: '„Åô„Åπ„Å¶„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ', startDate: 'ÈñãÂßãÊó•' },
                        statuses: { activo: 'ÈÄ≤Ë°å‰∏≠', latente: 'ÊΩúÂú®ÁöÑ', resuelto: 'Ëß£Ê±∫Ê∏à„Åø', desconocido: '‰∏çÊòé' },
                        sectors: { 'Minero': 'Èâ±Ê•≠', 'Agua': 'Ê∞¥', 'Forestal': 'ÊûóÊ•≠', 'Industrial': 'Áî£Ê•≠', 'Energ√©tico': '„Ç®„Éç„É´„ÇÆ„Éº', 'Protesta Social': 'Á§æ‰ºöÊäóË≠∞', 'Otro': '„Åù„ÅÆ‰ªñ' },
                        loading: 'Wikidata„Å´Âïè„ÅÑÂêà„Çè„Åõ‰∏≠...',
                        stats: { title: 'Áµ±Ë®à', total: 'ÂêàË®à', active: 'ÈÄ≤Ë°å‰∏≠', latent: 'ÊΩúÂú®ÁöÑ', resolved: 'Ëß£Ê±∫Ê∏à„Åø', sectorDistribution: '„Çª„ÇØ„Çø„ÉºÂà•ÂàÜÂ∏É' },
                        details: { location: 'Â†¥ÊâÄ', approximate: '(„Åä„Åä„Çà„Åù)', startDate: 'ÈñãÂßãÊó•', viewOnWikidata: 'Wikidata„ÅßË°®Á§∫', viewOnWikipedia: 'Wikipedia„ÅßË°®Á§∫', viewOnCommons: 'Commons„ÅßË°®Á§∫', noName: 'ÂêçÂâç„Å™„Åó', noDescription: 'Ë™¨Êòé„Å™„Åó', imageAlt: '„ÅÆÁîªÂÉè' },
                        statusInfo: { Activo: { icon: 'fa-fire-alt', text: 'ÈÄ≤Ë°å‰∏≠„ÅÆÁ¥õ‰∫â' }, Latente: { icon: 'fa-hourglass-half', text: 'ÊΩúÂú®ÁöÑ„Å™Á¥õ‰∫â' }, Resuelto: { icon: 'fa-check-circle', text: 'Ëß£Ê±∫Ê∏à„Åø„ÅÆÁ¥õ‰∫â' }, Desconocido: { icon: 'fa-question-circle', text: '‰∏çÊòé„Å™„Çπ„ÉÜ„Éº„Çø„Çπ' } },
                        tutorial: { step1: { title: '„Éï„Ç£„É´„Çø„Éº„Éë„Éç„É´', text: '„Åì„Åì„ÅßÂõΩ„ÄÅÂêçÂâç„ÄÅ„Çª„ÇØ„Çø„Éº„Å™„Å©„ÅßÁ¥õ‰∫â„Çí„Éï„Ç£„É´„Çø„Éº„Åß„Åç„Åæ„Åô„ÄÇ„ÄåÁ¥õ‰∫â„ÇíË°®Á§∫„Äç„ÇíÊäº„Åó„Å¶ÈñãÂßã„Åó„Åæ„Åô„ÄÇ' }, step2: { title: '„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Éû„ÉÉ„Éó', text: 'Á¥õ‰∫â„ÅØ„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇÁ†¥Á∑ö„ÅÆÁÇπ„ÅØ„Åä„Åä„Çà„Åù„ÅÆÂ†¥ÊâÄ„ÇíÁ§∫„Åó„Åæ„Åô„ÄÇË©≥Á¥∞„ÇíË¶ã„Çã„Å´„ÅØÁÇπ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ' }, step3: { title: 'Áµ±Ë®à„Å®Ë©≥Á¥∞', text: '„Åì„ÅÆ„Éë„Éç„É´„Å´„ÅØË°®Á§∫„Åï„Çå„ÅüÁ¥õ‰∫â„ÅÆÊ¶ÇË¶Å„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇÂú∞Âõ≥„ÅßÁ¥õ‰∫â„ÇíÈÅ∏Êäû„Åô„Çã„Å®„ÄÅË©≥Á¥∞ÊÉÖÂ†±„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ' }, previous: 'Ââç„Å∏', next: 'Ê¨°„Å∏', finish: 'ÁµÇ‰∫Ü' },
                        welcome: { title: 'Êé¢Á¥¢ÈñãÂßã', message: 'Ê∫ñÂÇôÂÆå‰∫ÜÔºÅÁ§æ‰ºöÁí∞Â¢ÉÁ¥õ‰∫â„ÇíÈñ≤Ë¶ß„ÄÅ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„ÄÅÁô∫Ë¶ã„Åß„Åç„Åæ„Åô„ÄÇÂ•ΩÂ•áÂøÉ„Çí„Ç¨„Ç§„Éâ„Å´„Åó„Åæ„Åó„Çá„ÅÜÔºÅ', button: 'Êé¢Á¥¢„ÇíÂßã„ÇÅ„Çã' },
                        footer: { text: 'Wikimedia Foundation„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åß„ÅÇ„ÇãWikidata„ÅÆ„Éá„Éº„Çø„Çí‰ΩøÁî®„Åó„Å¶ÈñãÁô∫„Åï„Çå„Åæ„Åó„Åü„ÄÇ', copyright: 'Wikimedia Chile. „Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅØCC BY-SA 4.0„É©„Ç§„Çª„É≥„Çπ„ÅßÂà©Áî®ÂèØËÉΩ„Åß„Åô„ÄÇ' },
                        selectAll: '„Åô„Åπ„Å¶ÈÅ∏Êäû',
                        deselectAll: '„Åô„Åπ„Å¶ÈÅ∏ÊäûËß£Èô§',
                        theme: { toggle: '„ÉÜ„Éº„Éû„ÇíÂàá„ÇäÊõø„Åà' }
                    },
                    pt: {
                        header: { title: 'GeoConflitos', subtitle: 'Mapa de conflitos socioambientais' },
                        filters: { title: 'Filtros', country: 'Pa√≠s', selectCountries: 'Selecionar pa√≠ses...', searchCountry: 'Pesquisar pa√≠s...', viewConflicts: 'Ver Conflitos', searchByName: 'Pesquisar por nome', searchPlaceholder: 'Ex: Belo Monte...', region: 'Regi√£o', allRegions: 'Todas as regi√µes', sector: 'Setor', allSectors: 'Todos os setores', status: 'Estado', allStatuses: 'Todos os estados', startDate: 'Data de in√≠cio' },
                        statuses: { activo: 'Ativo', latente: 'Latente', resuelto: 'Resolvido', desconocido: 'Desconhecido' },
                        sectors: { 'Minero': 'Minera√ß√£o', 'Agua': '√Ågua', 'Forestal': 'Florestal', 'Industrial': 'Industrial', 'Energ√©tico': 'Energia', 'Protesta Social': 'Protesto Social', 'Otro': 'Outro' },
                        loading: 'Consultando o Wikidata...',
                        stats: { title: 'Estat√≠sticas', total: 'Total', active: 'Ativos', latent: 'Latentes', resolved: 'Resolvidos', sectorDistribution: 'Distribui√ß√£o por Setor' },
                        details: { location: 'Localiza√ß√£o', approximate: '(aprox.)', startDate: 'Data de In√≠cio', viewOnWikidata: 'Ver no Wikidata', viewOnWikipedia: 'Ver na Wikip√©dia', viewOnCommons: 'Ver no Commons', noName: 'Sem nome', noDescription: 'Sem descri√ß√£o', imageAlt: 'Imagem de' },
                        statusInfo: { Activo: { icon: 'fa-fire-alt', text: 'Conflito Ativo' }, Latente: { icon: 'fa-hourglass-half', text: 'Conflito Latente' }, Resuelto: { icon: 'fa-check-circle', text: 'Conflito Resolvido' }, Desconocido: { icon: 'fa-question-circle', text: 'Estado Desconhecido' } },
                        tutorial: { step1: { title: 'Painel de Filtros', text: 'Aqui voc√™ pode filtrar conflitos por pa√≠s, nome, setor e mais. Selecione um ou mais pa√≠ses e pressione "Ver Conflitos" para come√ßar.' }, step2: { title: 'Mapa Interativo', text: 'Os conflitos aparecer√£o aqui. Pontos com borda tracejada indicam uma localiza√ß√£o aproximada. Clique em um ponto para mais detalhes.' }, step3: { title: 'Estat√≠sticas e Detalhes', text: 'Este painel mostra um resumo dos conflitos exibidos. Ao selecionar um conflito no mapa, suas informa√ß√µes detalhadas aparecer√£o aqui.' }, previous: 'Anterior', next: 'Pr√≥ximo', finish: 'Finalizar' },
                        welcome: { title: 'Explora√ß√£o Iniciada', message: 'Tudo pronto! Agora voc√™ pode navegar, filtrar e descobrir os conflitos socioambientais. Deixe sua curiosidade ser seu guia!', button: 'Come√ßar a Explorar' },
                        footer: { text: 'Desenvolvido com dados do Wikidata, um projeto da Funda√ß√£o Wikimedia.', copyright: 'Wikimedia Chile. Conte√∫do dispon√≠vel sob a licen√ßa CC BY-SA 4.0.' },
                        selectAll: 'Selecionar todos',
                        deselectAll: 'Desmarcar todos',
                        theme: { toggle: 'Alterar tema' }
                    },
                    fr: {
                        header: { title: 'G√©oConflits', subtitle: 'Carte des conflits socio-environnementaux' },
                        filters: { title: 'Filtres', country: 'Pays', selectCountries: 'S√©lectionner des pays...', searchCountry: 'Rechercher un pays...', viewConflicts: 'Voir les Conflits', searchByName: 'Rechercher par nom', searchPlaceholder: 'Ex: Notre-Dame-des-Landes...', region: 'R√©gion', allRegions: 'Toutes les r√©gions', sector: 'Secteur', allSectors: 'Tous les secteurs', status: 'Statut', allStatuses: 'Tous les statuts', startDate: 'Date de d√©but' },
                        statuses: { activo: 'Actif', latente: 'Latent', resuelto: 'R√©solu', desconocido: 'Inconnu' },
                        sectors: { 'Minero': 'Minier', 'Agua': 'Eau', 'Forestal': 'Forestier', 'Industrial': 'Industriel', 'Energ√©tico': '√ânergie', 'Protesta Social': 'Protestation Sociale', 'Otro': 'Autre' },
                        loading: 'Interrogation de Wikidata...',
                        stats: { title: 'Statistiques', total: 'Total', active: 'Actifs', latent: 'Latents', resolved: 'R√©solus', sectorDistribution: 'Distribution par Secteur' },
                        details: { location: 'Emplacement', approximate: '(approx.)', startDate: 'Date de d√©but', viewOnWikidata: 'Voir sur Wikidata', viewOnWikipedia: 'Voir sur Wikip√©dia', viewOnCommons: 'Voir sur Commons', noName: 'Sans nom', noDescription: 'Aucune description', imageAlt: 'Image de' },
                        statusInfo: { Activo: { icon: 'fa-fire-alt', text: 'Conflit Actif' }, Latente: { icon: 'fa-hourglass-half', text: 'Conflit Latent' }, Resuelto: { icon: 'fa-check-circle', text: 'Conflit R√©solu' }, Desconocido: { icon: 'fa-question-circle', text: 'Statut Inconnu' } },
                        tutorial: { step1: { title: 'Panneau des filtres', text: 'Ici, vous pouvez filtrer les conflits par pays, nom, secteur, etc. S√©lectionnez un ou plusieurs pays et appuyez sur "Voir les conflits" pour commencer.' }, step2: { title: 'Carte interactive', text: 'Les conflits appara√Ætront ici. Les points avec une bordure en pointill√© indiquent un emplacement approximatif. Cliquez sur un point pour plus de d√©tails.' }, step3: { title: 'Statistiques et d√©tails', text: 'Ce panneau affiche un r√©sum√© des conflits visualis√©s. Lorsque vous s√©lectionnez un conflit sur la carte, ses informations d√©taill√©es s\'affichent ici.' }, previous: 'Pr√©c√©dent', next: 'Suivant', finish: 'Terminer' },
                        welcome: { title: 'Exploration commenc√©e', message: 'Tout est pr√™t ! Vous pouvez maintenant parcourir, filtrer et d√©couvrir les conflits socio-environnementaux. Laissez votre curiosit√© vous guider !', button: 'Commencer √† explorer' },
                        footer: { text: 'D√©velopp√© avec les donn√©es de Wikidata, un projet de la Fondation Wikimedia.', copyright: 'Wikimedia Chile. Contenu disponible sous licence CC BY-SA 4.0.' },
                        selectAll: 'Tout s√©lectionner',
                        deselectAll: 'Tout d√©s√©lectionner',
                        theme: { toggle: 'Changer de th√®me' }
                    },
                    de: {
                        header: { title: 'GeoKonflikte', subtitle: 'Karte der sozio-√∂kologischen Konflikte' },
                        filters: { title: 'Filter', country: 'Land', selectCountries: 'L√§nder ausw√§hlen...', searchCountry: 'Land suchen...', viewConflicts: 'Konflikte anzeigen', searchByName: 'Suche nach Name', searchPlaceholder: 'Z.B.: Hambacher Forst...', region: 'Region', allRegions: 'Alle Regionen', sector: 'Sektor', allSectors: 'Alle Sektoren', status: 'Status', allStatuses: 'Alle Status', startDate: 'Startdatum' },
                        statuses: { activo: 'Aktiv', latente: 'Latent', resuelto: 'Gel√∂st', desconocido: 'Unbekannt' },
                        sectors: { 'Minero': 'Bergbau', 'Agua': 'Wasser', 'Forestal': 'Forstwirtschaft', 'Industrial': 'Industrie', 'Energ√©tico': 'Energie', 'Protesta Social': 'Sozialer Protest', 'Otro': 'Andere' },
                        loading: 'Wikidata wird abgefragt...',
                        stats: { title: 'Statistiken', total: 'Gesamt', active: 'Aktiv', latent: 'Latent', resolved: 'Gel√∂st', sectorDistribution: 'Verteilung nach Sektor' },
                        details: { location: 'Standort', approximate: '(ca.)', startDate: 'Startdatum', viewOnWikidata: 'Auf Wikidata ansehen', viewOnWikipedia: 'Auf Wikipedia ansehen', viewOnCommons: 'Auf Commons ansehen', noName: 'Ohne Namen', noDescription: 'Keine Beschreibung', imageAlt: 'Bild von' },
                        statusInfo: { Activo: { icon: 'fa-fire-alt', text: 'Aktiver Konflikt' }, Latente: { icon: 'fa-hourglass-half', text: 'Latenter Konflikt' }, Resuelto: { icon: 'fa-check-circle', text: 'Gel√∂ster Konflikt' }, Desconocido: { icon: 'fa-question-circle', text: 'Unbekannter Status' } },
                        tutorial: { step1: { title: 'Filterbereich', text: 'Hier k√∂nnen Sie Konflikte nach Land, Name, Sektor und mehr filtern. W√§hlen Sie ein oder mehrere L√§nder aus und dr√ºcken Sie "Konflikte anzeigen", um zu beginnen.' }, step2: { title: 'Interaktive Karte', text: 'Konflikte werden hier angezeigt. Gestrichelte Punkte deuten auf einen ungef√§hren Standort hin. Klicken Sie auf einen Punkt f√ºr weitere Details.' }, step3: { title: 'Statistiken & Details', text: 'Dieser Bereich zeigt eine Zusammenfassung der angezeigten Konflikte. Wenn Sie einen Konflikt auf der Karte ausw√§hlen, werden hier dessen detaillierte Informationen angezeigt.' }, previous: 'Zur√ºck', next: 'Weiter', finish: 'Beenden' },
                        welcome: { title: 'Erkundung gestartet', message: 'Alles bereit! Sie k√∂nnen jetzt sozio-√∂kologische Konflikte durchsuchen, filtern und entdecken. Lassen Sie sich von Ihrer Neugier leiten!', button: 'Erkundung starten' },
                        footer: { text: 'Entwickelt mit Daten von Wikidata, einem Projekt der Wikimedia Foundation.', copyright: 'Wikimedia Chile. Inhalte verf√ºgbar unter der CC BY-SA 4.0 Lizenz.' },
                        selectAll: 'Alle ausw√§hlen',
                        deselectAll: 'Auswahl aufheben',
                        theme: { toggle: 'Thema wechseln' }
                    },
                };

                const t = (key) => {
                    const keys = key.split('.');
                    let result = translations[currentLang.value] || translations['es'];
                    for (const k of keys) {
                        if (result) result = result[k];
                        else break;
                    }
                    if (result === undefined) {
                         const fallbackKeys = key.split('.');
                         let fallbackResult = translations['es'];
                         for (const fk of fallbackKeys) {
                             if (fallbackResult) fallbackResult = fallbackResult[fk];
                             else return key;
                         }
                         return fallbackResult;
                    }
                    return result;
                };

                // --- ESTADO REACTIVO DE LA APLICACI√ìN ---
                const isLoading = ref(false);
                const countries = ref([]);
                const allConflicts = ref([]);
                const activeConflict = ref(null);
                const filters = reactive({ country: [QID_CHILE], search: '', region: '', sector: '', status: '', date: '' });
                const isCountryDropdownOpen = ref(false);
                const countrySearchTerm = ref('');
                const countrySelectContainer = ref(null);
                const isTutorialActive = ref(false);
                const tutorialStep = ref(0);
                const showWelcomeModal = ref(false);
                const tutorialPopupStyle = ref({});
                const tutorialHighlightStyle = ref({});
                const theme = ref('light');
                let map = null;
                let markers = null;
                const mapContainer = ref(null);
                
                const toggleTheme = () => {
                    const newTheme = theme.value === 'light' ? 'dark' : 'light';
                    theme.value = newTheme;
                };

                watch(theme, (newTheme) => {
                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('geoConflictosTheme', newTheme);
                });


                // --- PROPIEDADES COMPUTADAS ---
                const filteredConflicts = computed(() => {
                    if (allConflicts.value.length === 0) return [];
                    return allConflicts.value.filter(c => 
                        (!filters.region || `${c.countryName} - ${c.region}` === filters.region) &&
                        (!filters.sector || c.sector === filters.sector) &&
                        (!filters.status || c.status === filters.status) &&
                        (!filters.date || (c.startDate && new Date(c.startDate) >= new Date(filters.date))) &&
                        (!filters.search || c.name.toLowerCase().includes(filters.search.toLowerCase()))
                    );
                });

                const stats = computed(() => {
                    const data = filteredConflicts.value;
                    const sectorsMap = {};
                    data.forEach(c => { sectorsMap[c.sector] = (sectorsMap[c.sector] || 0) + 1; });
                    
                    const sortedSectors = Object.entries(sectorsMap).sort(([, a], [, b]) => b - a).map(([name, count]) => ({
                        name,
                        count,
                        percentage: data.length > 0 ? Math.round((count / data.length) * 100) : 0,
                        color: sectorColors[name] || '#607d8b',
                        icon: sectorIcons[name] || 'fas fa-question-circle'
                    }));

                    return {
                        total: data.length,
                        active: data.filter(c => c.status === 'Activo').length,
                        latent: data.filter(c => c.status === 'Latente').length,
                        resolved: data.filter(c => c.status === 'Resuelto').length,
                        sectors: sortedSectors
                    };
                });

                const filterOptions = computed(() => {
                    const regions = [...new Set(allConflicts.value.filter(c => c.region && c.region !== 'Not specified' && c.countryName).map(c => `${c.countryName} - ${c.region}`))].sort();
                    const sectors = [...new Set(allConflicts.value.map(c => c.sector).filter(Boolean))].sort();
                    return { regions, sectors };
                });

                const filteredCountries = computed(() => {
                    if (!countrySearchTerm.value) return countries.value;
                    return countries.value.filter(c => c.name.toLowerCase().includes(countrySearchTerm.value.toLowerCase()));
                });
                
                const tutorialSteps = computed(() => [
                    { element: '#filters-panel', title: t('tutorial.step1.title'), text: t('tutorial.step1.text') },
                    { element: '#map-area', title: t('tutorial.step2.title'), text: t('tutorial.step2.text') },
                    { element: '#stats-panel', title: t('tutorial.step3.title'), text: t('tutorial.step3.text') }
                ]);
                const currentTutorialStep = computed(() => tutorialSteps.value[tutorialStep.value]);

                const selectAllButtonText = computed(() => {
                    if (countries.value.length === 0) return t('selectAll');
                    return filters.country.length === countries.value.length ? t('deselectAll') : t('selectAll');
                });

                // --- M√âTODOS ---
                const fetchData = async (countryQIDs) => {
                    if (!countryQIDs || countryQIDs.length === 0) {
                        allConflicts.value = [];
                        return;
                    }
                    isLoading.value = true;
                    activeConflict.value = null;
                    const countriesFilter = `VALUES ?country { ${countryQIDs.map(id => `wd:${id}`).join(' ')} }`;
                    const sparqlQuery = `SELECT ?conflict ?conflictLabel ?description ?coords ?startDate ?endDate ?adminEntity ?adminEntityLabel ?wikipediaUrl ?countryLabel ?image ?commonsCategory WHERE { ${countriesFilter} ?conflict wdt:P17 ?country. VALUES ?type { wd:Q5683226 wd:Q472983 wd:Q1983228 wd:Q1193633 wd:Q49343 wd:Q274880 } ?conflict wdt:P31 ?type. OPTIONAL { ?conflict wdt:P625 ?coords. } OPTIONAL { ?conflict wdt:P580 ?startDate. } OPTIONAL { ?conflict wdt:P582 ?endDate. } OPTIONAL { ?conflict wdt:P131 ?adminEntity. } OPTIONAL { ?conflict wdt:P18 ?image. } OPTIONAL { ?conflict wdt:P373 ?commonsCategory. } OPTIONAL { ?wikipediaUrl schema:about ?conflict; schema:inLanguage "${currentLang.value}"; schema:isPartOf <https://${currentLang.value}.wikipedia.org/>. } SERVICE wikibase:label { bd:serviceParam wikibase:language "${currentLang.value},en,es". ?conflict rdfs:label ?conflictLabel; schema:description ?description. ?adminEntity rdfs:label ?adminEntityLabel. ?country rdfs:label ?countryLabel. } }`;
                    const url = `https://query.wikidata.org/sparql?query=${encodeURIComponent(sparqlQuery)}&format=json`;
                    try {
                        const response = await fetch(url, { headers: { 'Accept': 'application/json' } });
                        if (!response.ok) throw new Error(`Network error: ${response.status}`);
                        const data = await response.json();
                        await processData(data);
                    } catch (error) {
                        console.error("Error fetching conflicts:", error);
                    } finally {
                        isLoading.value = false;
                    }
                };
                
                const getConflictSector = (conflict) => {
                    const textToSearch = `${(conflict.name || '').toLowerCase()} ${(conflict.description || '').toLowerCase()}`;
                    const keywordsForLang = sectorKeywords[currentLang.value] || sectorKeywords['en'];
                    for (const [sector, keywords] of Object.entries(keywordsForLang)) {
                        if (keywords.some(k => textToSearch.includes(k))) {
                            return sector;
                        }
                    }
                    return 'Otro';
                };
                
                const onImageError = (event) => {
                    event.target.style.display = 'none';
                };

                const processData = async (data) => {
                    const uniqueConflicts = new Map();
                     data.results.bindings.forEach(b => {
                         const id = b.conflict.value.split('/').pop();
                         if (!uniqueConflicts.has(id)) {
                             const conflict = { id, name: b.conflictLabel?.value || t('details.noName'), description: b.description?.value || t('details.noDescription'), startDate: b.startDate?.value, endDate: b.endDate?.value, region: b.adminEntityLabel?.value || 'Not specified', adminEntityId: b.adminEntity?.value.split('/').pop(), coords: null, isImprecise: false, wikipediaUrl: b.wikipediaUrl?.value, countryName: b.countryLabel?.value, imageUrl: b.image?.value, commonsUrl: b.commonsCategory?.value ? `https://commons.wikimedia.org/wiki/Category:${b.commonsCategory.value.replace(/ /g, '_')}` : null };
                             if (b.coords) { const match = b.coords.value.match(/Point\(([-\d.]+) ([-\d.]+)\)/); if (match) conflict.coords = [parseFloat(match[2]), parseFloat(match[1])]; }
                             conflict.status = determineStatus(conflict.startDate, conflict.endDate);
                             conflict.sector = getConflictSector(conflict);
                             uniqueConflicts.set(id, conflict);
                         }
                     });
                    const processedConflicts = Array.from(uniqueConflicts.values());

                    const conflictsToGeocode = processedConflicts.filter(c => !c.coords && c.adminEntityId);
                    if (conflictsToGeocode.length > 0) {
                        const adminCoordsMap = await geocodeAdminEntities(conflictsToGeocode);
                        processedConflicts.forEach(conflict => {
                            if (!conflict.coords && conflict.adminEntityId && adminCoordsMap.has(conflict.adminEntityId)) {
                                conflict.coords = adminCoordsMap.get(conflict.adminEntityId);
                                conflict.isImprecise = true;
                            }
                        });
                    }
                    allConflicts.value = processedConflicts;
                };

                const geocodeAdminEntities = async (conflicts) => {
                    const adminIds = [...new Set(conflicts.map(c => c.adminEntityId))];
                    if (adminIds.length === 0) return new Map();
                    const sparqlQuery = `SELECT ?entity ?coords WHERE { VALUES ?entity { ${adminIds.map(id => `wd:${id}`).join(' ')} } ?entity wdt:P625 ?coords. }`;
                    const url = `https://query.wikidata.org/sparql?query=${encodeURIComponent(sparqlQuery)}&format=json`;
                    const adminCoordsMap = new Map();
                    try {
                        const response = await fetch(url, { headers: { 'Accept': 'application/json' } });
                        if (!response.ok) return adminCoordsMap;
                        const data = await response.json();
                        data.results.bindings.forEach(b => {
                            const entityId = b.entity.value.split('/').pop();
                            const match = b.coords.value.match(/Point\(([-\d.]+) ([-\d.]+)\)/);
                            if(match) adminCoordsMap.set(entityId, [parseFloat(match[2]), parseFloat(match[1])]);
                        });
                    } catch (error) { console.error("Error geocoding:", error); }
                    return adminCoordsMap;
                };

                const onCountryChange = () => fetchData(filters.country);
                
                const showConflictDetails = async (conflict) => {
                    activeConflict.value = conflict;
                    if ((conflict.description.toLowerCase().trim().includes('conflict') || conflict.description.toLowerCase().trim().includes('conflicto') || conflict.description.toLowerCase().trim() === t('details.noDescription')) && conflict.wikipediaUrl) {
                        const summary = await fetchWikipediaSummary(conflict.wikipediaUrl);
                        if (summary && activeConflict.value?.id === conflict.id) {
                            activeConflict.value.description = summary;
                        }
                    }
                };

                const fetchWikipediaSummary = async (wikipediaUrl) => {
                    if (!wikipediaUrl) return null;
                    try {
                        const pageTitle = decodeURIComponent(wikipediaUrl.split('/').pop());
                        const apiUrl = `https://${currentLang.value}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(pageTitle)}`;
                        const response = await fetch(apiUrl);
                        if (!response.ok) return null;
                        const data = await response.json();
                        return data.extract || null;
                    } catch { return null; }
                };
                const determineStatus = (startDateStr, endDateStr) => { const now = new Date(); if (endDateStr && new Date(endDateStr) < now) return 'Resuelto'; if (startDateStr) return new Date(startDateStr) < new Date(new Date().setFullYear(new Date().getFullYear() - 15)) ? 'Latente' : 'Activo'; return 'Desconocido'; };
                
                const getSectorColor = (sector) => sectorColors[sector] || '#607d8b';
                const getStatusInfo = (status) => t('statusInfo')[status] || t('statusInfo')['Desconocido'];
                const formatDate = (dateString) => dateString ? new Date(dateString).toLocaleDateString(currentLang.value) : t('statuses.desconocido');
                const openLink = (url) => { if(url) window.open(url, '_blank'); };

                const getCountryName = (id) => countries.value.find(c => c.id === id)?.name || id;
                const removeCountry = (id) => { filters.country = filters.country.filter(cId => cId !== id); };
                
                const toggleSelectAllCountries = () => {
                    if (filters.country.length === countries.value.length) {
                        filters.country = [];
                    } else {
                        filters.country = countries.value.map(c => c.id);
                    }
                };
                const changeLanguage = async (langCode) => {
                    currentLang.value = langCode;
                    document.documentElement.lang = langCode;
                    isLangDropdownOpen.value = false;
                    await fetchCountries(); // Re-fetch country names in the new language
                    await fetchData(filters.country); // Re-fetch conflicts
                };

                const nextStep = () => { if (tutorialStep.value < tutorialSteps.value.length - 1) tutorialStep.value++; };
                const prevStep = () => { if (tutorialStep.value > 0) tutorialStep.value--; };
                const finishTutorial = () => {
                    isTutorialActive.value = false;
                    showWelcomeModal.value = true;
                    localStorage.setItem('geoConflictosTutorialSeen', 'true');
                };
                const closeWelcomeModal = () => {
                    showWelcomeModal.value = false;
                };

                const updateTutorialHighlight = () => {
                    if (!isTutorialActive.value) return;
                    const step = currentTutorialStep.value;
                    const targetElement = document.querySelector(step.element);
                    if (!targetElement) return;

                    const rect = targetElement.getBoundingClientRect();
                    const padding = 10;
                    
                    tutorialHighlightStyle.value = {
                        top: `${rect.top - padding}px`,
                        left: `${rect.left - padding}px`,
                        width: `${rect.width + (padding * 2)}px`,
                        height: `${rect.height + (padding * 2)}px`,
                    };

                    tutorialPopupStyle.value = {
                        top: '50%',
                        left: '50%',
                        transform: 'translate(-50%, -50%)',
                    };
                };
                
                const handleClickOutside = (event) => {
                    if (countrySelectContainer.value && !countrySelectContainer.value.contains(event.target)) {
                        isCountryDropdownOpen.value = false;
                    }
                    if (langSwitcherContainer.value && !langSwitcherContainer.value.contains(event.target)) {
                        isLangDropdownOpen.value = false;
                    }
                };
                
                const handleResize = () => {
                    if (isTutorialActive.value) {
                        updateTutorialHighlight();
                    }
                };

                const fetchCountries = async () => {
                     const sparqlQuery = `SELECT DISTINCT ?country ?countryLabel WHERE { VALUES ?type { wd:Q5683226 wd:Q472983 } ?conflict wdt:P31 ?type; wdt:P17 ?country. SERVICE wikibase:label { bd:serviceParam wikibase:language "${currentLang.value},en,es". } } ORDER BY ?countryLabel`;
                    const url = `https://query.wikidata.org/sparql?query=${encodeURIComponent(sparqlQuery)}&format=json`;
                    try {
                        const response = await fetch(url, { headers: { 'Accept': 'application/json' } });
                        const data = await response.json();
                        countries.value = data.results.bindings.map(b => ({ id: b.country.value.split('/').pop(), name: b.countryLabel.value })).filter(c => c.name);
                    } catch (error) {
                         console.error("Error fetching countries:", error);
                    }
                };

                onMounted(async () => {
                    const savedTheme = localStorage.getItem('geoConflictosTheme');
                    if (savedTheme) {
                        theme.value = savedTheme;
                    } else {
                        theme.value = 'light';
                    }
                    document.documentElement.setAttribute('data-theme', theme.value);


                    const userLang = navigator.language.split('-')[0];
                    if (Object.keys(supportedLangs).includes(userLang)) {
                        currentLang.value = userLang;
                    }
                    document.documentElement.lang = currentLang.value;

                    map = L.map(mapContainer.value).setView([-40, -71], 4);
                    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: '&copy; OpenStreetMap' }).addTo(map);
                    markers = L.featureGroup().addTo(map);
                    
                    await fetchCountries();
                    await fetchData(filters.country);
                    
                    document.addEventListener('click', handleClickOutside);
                    window.addEventListener('resize', handleResize);

                    if (localStorage.getItem('geoConflictosTutorialSeen') !== 'true') {
                        setTimeout(() => {
                            isTutorialActive.value = true;
                        }, 500);
                    }
                });
                
                onBeforeUnmount(() => {
                    document.removeEventListener('click', handleClickOutside);
                    window.removeEventListener('resize', handleResize);
                });

                watch(isTutorialActive, (isActive) => {
                    document.documentElement.classList.toggle('tutorial-active', isActive);
                    document.body.classList.toggle('tutorial-active', isActive);
                    if (isActive) {
                        nextTick(() => {
                            updateTutorialHighlight();
                        });
                    }
                });
                watch(tutorialStep, updateTutorialHighlight);

                watch(filteredConflicts, (newConflicts) => {
                    if (!map || !markers) return;
                    markers.clearLayers();
                    const conflictsWithCoords = newConflicts.filter(c => c.coords);

                    conflictsWithCoords.forEach(conflict => {
                        let markerStyle = `background-color: ${getSectorColor(conflict.sector)}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 8px rgba(0,0,0,0.6);`;
                        if (conflict.isImprecise) {
                            markerStyle += ` border-style: dashed; opacity: 0.8;`;
                        }
                        const icon = L.divIcon({ className: 'custom-marker', html: `<div style="${markerStyle}"></div>`, iconSize:[24,24], iconAnchor:[12,12] });
                        
                        L.marker(conflict.coords, { icon: icon })
                            .addTo(markers)
                            .bindPopup(`<strong>${conflict.name}</strong><br><em>${t('sectors.' + conflict.sector)}</em>`)
                            .on("click", () => showConflictDetails(conflict));
                    });

                    if (markers.getLayers().length > 0) {
                        map.invalidateSize();
                        if (filters.country.length === 1 && filters.country[0] === QID_CHILE) {
                             map.setView([-35.6751, -71.543], 5);
                        } else {
                             map.fitBounds(markers.getBounds(), { padding: [50, 50] });
                        }
                    } else {
                        map.setView([20,10], 2);
                    }
                });

                return {
                    isLoading, countries, filters, filteredConflicts, stats, filterOptions, activeConflict, mapContainer, onCountryChange, getSectorColor, getStatusInfo, formatDate, openLink, isCountryDropdownOpen, countrySearchTerm, filteredCountries, getCountryName, removeCountry, countrySelectContainer, isTutorialActive, tutorialStep, currentTutorialStep, nextStep, prevStep, finishTutorial, tutorialPopupStyle, tutorialHighlightStyle, showWelcomeModal, closeWelcomeModal, toggleSelectAllCountries, selectAllButtonText, supportedLangs, currentLang, changeLanguage, isLangDropdownOpen, langSwitcherContainer, t, tutorialSteps, theme, toggleTheme, onImageError
                };
            }
        }).mount('#app');
    </script>
</body>
</html>

